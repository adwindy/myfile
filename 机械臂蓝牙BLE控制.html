<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>BLE æœºæ¢°è‡‚æ§åˆ¶ - 6ç»„æ»‘å—ç²¾å‡†å¯¹é½ç‰ˆ</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f5f5f5;
  user-select: none;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: #ffffff;
  box-shadow: 0 1px 4px rgba(0,0,0,.1);
}

/* headeræŒ‰é’®ï¼šæ–°å¢è§¦æ‘¸åé¦ˆ + æ¶ˆé™¤ç‚¹å‡»é«˜äº® + å¼ºåŒ–active */
header button {
  border: none;
  background: #eee;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent; /* æ¶ˆé™¤æµè§ˆå™¨é»˜è®¤ç‚¹å‡»é«˜äº® */
  touch-action: manipulation; /* ç¦ç”¨åŒå‡»ç¼©æ”¾ï¼Œæå‡ç‚¹å‡»å“åº” */
  transition: background 0.1s ease; /* è¿‡æ¸¡åŠ¨ç”»ï¼Œè®©åé¦ˆæ›´é¡ºæ»‘ */
}
header button:active {
  background: #d1d5db; /* åŠ æ·±åº•è‰²ï¼Œæ˜æ˜¾è‰²å·®åé¦ˆ */
  transform: scale(0.98); /* è½»å¾®ç¼©å°ï¼Œæ¨¡æ‹Ÿç‰©ç†æŒ‰é’®æŒ‰ä¸‹ */
}

/* æ»‘å—ä¾§è¾¹label-btnï¼šæ–°å¢è§¦æ‘¸åé¦ˆ + æ¶ˆé™¤ç‚¹å‡»é«˜äº® */
.label-btn {
  width: 55px;
  height: 32px;
  border: none;
  background: #3b82f6;
  color: white;
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: all 0.1s ease;
}
.label-btn:active { 
  background: #1d4ed8; 
  transform: scale(0.98); /* æŒ‰ä¸‹è½»å¾®ç¼©å° */
}

/* footeræŒ‰é’®ï¼šæ–°å¢è§¦æ‘¸åé¦ˆ + æ¶ˆé™¤ç‚¹å‡»é«˜äº® + å¼ºåŒ–active */
footer button {
  padding: 15px 10px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #6366f1;
  color: white;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: all 0.1s ease;
}
footer button:active { 
  background: #4f46e5; 
  transform: scale(0.98);
}
footer button.secondary { background: #64748b; }
/* è¡¥å……secondaryæŒ‰é’®çš„activeæ ·å¼ï¼Œé¿å…æ— åé¦ˆ */
footer button.secondary:active {
  background: #475569;
  transform: scale(0.98);
}


/* æ ¸å¿ƒï¼šmainå®¹å™¨è®¾ç½®ä¸ºå›ºå®šé«˜åº¦ï¼ŒåŸºäºå›¾ç‰‡å®½é«˜æ¯”è®¡ç®— */
main {
  position: relative;
  padding: 10px;
  max-width: 600px;
  margin: 0 auto;
  /* åŸºäºå›¾ç‰‡å®½é«˜æ¯”è®¡ç®—é«˜åº¦ï¼š1406/1080 â‰ˆ 1.302 */
  /* å®¹å™¨å®½åº¦æ˜¯100%ï¼Œä½†æœ€å¤§600pxï¼Œé«˜åº¦ = å®½åº¦ * 1.302 */
  height: calc(100vw * 1.302);
  max-height: calc(600px * 1.302);
  min-height: 400px; /* æœ€å°é«˜åº¦ç¡®ä¿æ»‘å—å¯è§ */
  width: 100%;
  box-sizing: border-box;
  overflow: hidden;
  background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); /* å¤‡ç”¨èƒŒæ™¯ */
  border-radius: 8px;
}

/* æ ¸å¿ƒï¼šèƒŒæ™¯å›¾ä½œä¸ºå®šä½åŸºå‡†ï¼Œç­‰æ¯”ç¼©æ”¾ï¼Œç¦æ­¢å˜å½¢ */
.arm-bg {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: contain; /* ä¿æŒæ¯”ä¾‹ï¼Œå®Œæ•´æ˜¾ç¤º */
  opacity: 0.9;
  border-radius: 8px;
  margin: 0 auto;
  background: transparent;
}

/* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æç¤º */
.arm-bg::after {
  content: 'æœºæ¢°è‡‚ç¤ºæ„å›¾';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #666;
  font-size: 16px;
  display: none;
}

/* æ»‘å—ç»„åŸºç¡€æ ·å¼ï¼šç»å¯¹å®šä½+æ°´å¹³å±…ä¸­ï¼ŒJSæ¥ç®¡topå®šä½ */
.slider-group {
  position: absolute;
  left: 5%;
  right: 5%;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.8);
  padding: 6px 10px;
  border-radius: 25px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 10;
}

.label-btn {
  width: 55px;
  height: 32px;
  border: none;
  background: #3b82f6;
  color: white;
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.label-btn:active { background: #1d4ed8; }

/* æ»‘å—æ ·å¼ä¼˜åŒ–ï¼šéšè—é»˜è®¤è½¨é“ï¼Œè‡ªå®šä¹‰ä¸‰çº§å¸é™„ */
.slider-group input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  border-radius: 3px;
  background: #e2e8f0;
  outline: none;
  margin: 0;
}
/* æ»‘å—æ‹‡æŒ‡æ ·å¼ */
.slider-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #3b82f6;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.1s ease;
}
.slider-group input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #3b82f6;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.1s ease;
}

footer {
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  max-width: 600px;
  margin: 20px auto 10px;
  width: 100%;
  box-sizing: border-box;
}

footer button {
  padding: 15px 10px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #6366f1;
  color: white;
  cursor: pointer;
}

footer button:active { background: #4f46e5; }
footer button.secondary { background: #64748b; }

#configModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#configBox {
  background: white;
  padding: 20px;
  width: 85%;
  max-width: 400px;
  border-radius: 12px;
  max-height: 90vh;
  overflow-y: auto;
}

#configBox label {
  font-size: 14px;
  display: block;
  margin-top: 12px;
  color: #666;
}

#configBox input, #configBox select {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-sizing: border-box;
}

.modal-btns {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.modal-btns button {
  flex: 1;
  padding: 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

.btn-save { background: #3b82f6; color: white; }
.btn-close { background: #eee; color: #333; }

#statusInfo {
  font-size: 12px;
  color: #666;
  text-align: center;
  margin-top: 5px;
  height: 15px;
  width: 100%;
}
</style>
</head>

<body>

<header>
  <button onclick="openConfig()">âš™ é…ç½®</button>
  <div style="font-weight: bold;">æœºæ¢°è‡‚æ§åˆ¶ç³»ç»Ÿ</div>
  <button onclick="connectBLE()">ğŸ”µ æ‰«æè¿æ¥</button>
</header>

<div id="statusInfo">æœªè¿æ¥è“ç‰™</div>

<main>
  <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ -->
  <img class="arm-bg" src="jxb.jpg" onerror="handleImageError(this)" />


  <!-- 6ç»„æ»‘å—ï¼šæ·»åŠ data-joint-yå±æ€§ï¼Œç»‘å®šæœºæ¢°è‡‚å…³èŠ‚å‚ç›´ç™¾åˆ†æ¯”ï¼ŒJSåŠ¨æ€å®šä½ -->
  <div class="slider-group s1" data-joint-y="12">
    <button class="label-btn" id="L1">å¼ å¼€</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="1" onmousedown="sliderDown(1, this)" ontouchstart="sliderDown(1, this)" onmouseup="sliderUp(1, this)" ontouchend="sliderUp(1, this)" oninput="sliderMove(1, this)">
    <button class="label-btn" id="R1">é—­åˆ</button>
  </div>
  <div class="slider-group s2" data-joint-y="27.5">
    <button class="label-btn" id="L2">å·¦è½¬</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="2" onmousedown="sliderDown(2, this)" ontouchstart="sliderDown(2, this)" onmouseup="sliderUp(2, this)" ontouchend="sliderUp(2, this)" oninput="sliderMove(2, this)">
    <button class="label-btn" id="R2">å³è½¬</button>
  </div>
  <div class="slider-group s3" data-joint-y="42.8">
    <button class="label-btn" id="L3">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="3" onmousedown="sliderDown(3, this)" ontouchstart="sliderDown(3, this)" onmouseup="sliderUp(3, this)" ontouchend="sliderUp(3, this)" oninput="sliderMove(3, this)">
    <button class="label-btn" id="R3">å‘å‰</button>
  </div>
  <div class="slider-group s4" data-joint-y="58">
    <button class="label-btn" id="L4">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="4" onmousedown="sliderDown(4, this)" ontouchstart="sliderDown(4, this)" onmouseup="sliderUp(4, this)" ontouchend="sliderUp(4, this)" oninput="sliderMove(4, this)">
    <button class="label-btn" id="R4">å‘å‰</button>
  </div>
  <div class="slider-group s5" data-joint-y="73.2">
    <button class="label-btn" id="L5">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="5" onmousedown="sliderDown(5, this)" ontouchstart="sliderDown(5, this)" onmouseup="sliderUp(5, this)" ontouchend="sliderUp(5, this)" oninput="sliderMove(5, this)">
    <button class="label-btn" id="R5">å‘å‰</button>
  </div>
  <div class="slider-group s6" data-joint-y="88.7">
    <button class="label-btn" id="L6">å·¦è½¬</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="6" onmousedown="sliderDown(6, this)" ontouchstart="sliderDown(6, this)" onmouseup="sliderUp(6, this)" ontouchend="sliderUp(6, this)" oninput="sliderMove(6, this)">
    <button class="label-btn" id="R6">å³è½¬</button>
  </div>
</main>


<footer>
  <button id="G1">G1</button>
  <button id="G2">G2</button>
  <button id="G3">G3</button>
  <button id="G4">G4</button>
  <button class="secondary" id="STOP">åœæ­¢</button>
  <button class="secondary" id="RESET">å¤ä½</button>
</footer>

<div id="configModal">
  <div id="configBox">
    <h3 style="margin:0">åŠŸèƒ½é…ç½®</h3>
    <label>é€‰æ‹©æŒ‰é’®åºå·</label>
    <select id="cfgId" onchange="loadCurrentConfig()">
      <optgroup label="æ»‘å—ä¾§è¾¹æŒ‰é’®ã€6ç»„å®Œæ•´ã€‘">
        <option value="L1">æ»‘å—1-å·¦(å¼ å¼€)</option><option value="R1">æ»‘å—1-å³(é—­åˆ)</option>
        <option value="L2">æ»‘å—2-å·¦(å·¦è½¬)</option><option value="R2">æ»‘å—2-å³(å³è½¬)</option>
        <option value="L3">æ»‘å—3-å·¦(å‘å)</option><option value="R3">æ»‘å—3-å³(å‘å‰)</option>
        <option value="L4">æ»‘å—4-å·¦(å‘å)</option><option value="R4">æ»‘å—4-å³(å‘å‰)</option>
        <option value="L5">æ»‘å—5-å·¦(å‘å)</option><option value="R5">æ»‘å—5-å³(å‘å‰)</option>
        <option value="L6">æ»‘å—6-å·¦(å·¦è½¬)</option><option value="R6">æ»‘å—6-å³(å³è½¬)</option>
      </optgroup>
      <optgroup label="åº•éƒ¨åŠŸèƒ½æŒ‰é’®">
        <option value="G1">æŒ‰é’® G1</option><option value="G2">æŒ‰é’® G2</option>
        <option value="G3">æŒ‰é’® G3</option><option value="G4">æŒ‰é’® G4</option>
        <option value="STOP">åœæ­¢æŒ‰é’®</option><option value="RESET">å¤ä½æŒ‰é’®</option>
      </optgroup>
    </select>
    <label>æŒ‰é’®æ˜¾ç¤ºåç§°</label>
    <input id="cfgName">
    <label>æŒ‰ä¸‹å‘½ä»¤</label>
    <input id="cfgPress">
    <label>æŠ¬èµ·å‘½ä»¤ (å¯é€‰)</label>
    <input id="cfgRelease">
    <div class="modal-btns">
      <button class="btn-save" onclick="saveConfig()">ä¿å­˜</button>
      <button class="btn-close" onclick="closeConfig()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
let bleChar = null;
// æ»‘å—å®šæ—¶é‡å‘å®šæ—¶å™¨å­˜å‚¨ï¼škey=æ»‘å—IDï¼Œvalue=å®šæ—¶å™¨ID
let sliderTimers = {};
// æ»‘å—å½“å‰æ˜¯å¦æŒ‰ä½ï¼škey=æ»‘å—IDï¼Œvalue=boolean
let sliderHeld = {};
// å›¾ç‰‡åŠ è½½çŠ¶æ€
let imageLoaded = false;

// å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
function handleImageError(img) {
  console.log('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å¸ƒå±€');
  imageLoaded = false;
  img.style.opacity = '0';
  // ç«‹å³é‡æ–°å®šä½æ»‘å—ï¼ˆä½¿ç”¨å¤‡ç”¨é«˜åº¦ï¼‰
  positionSliders();
}

// ã€æ ¸å¿ƒä¿®æ­£ã€‘6ç»„æ»‘å—æŒ‰é’®æŒ‡ä»¤ç²¾å‡†åŒ¹é…ï¼Œä¸¥æ ¼æŒ‰æä¾›çš„æŒ‡ä»¤é…ç½®
const defaultConfigs = {
  // ç¬¬1ç»„ #005ï¼šå¼ å¼€/é—­åˆ
  L1: { name: "å¼ å¼€", press: "#005P0500T2000!", release: "#005PDST!" },
  R1: { name: "é—­åˆ", press: "#005P2500T2000!", release: "#005PDST!" },
  // ç¬¬2ç»„ #004ï¼šå·¦è½¬/å³è½¬
  L2: { name: "å·¦è½¬", press: "#004P0500T2000!", release: "#004PDST!" },
  R2: { name: "å³è½¬", press: "#004P2500T2000!", release: "#004PDST!" },
  // ç¬¬3ç»„ #003ï¼šå‘å/å‘å‰
  L3: { name: "å‘å", press: "#003P0500T2000!", release: "#003PDST!" },
  R3: { name: "å‘å‰", press: "#003P2500T2000!", release: "#003PDST!" },
  // ç¬¬4ç»„ #002ï¼šå‘å/å‘å‰
  L4: { name: "å‘å", press: "#002P0500T2000!", release: "#002PDST!" },
  R4: { name: "å‘å‰", press: "#002P2500T2000!", release: "#002PDST!" },
  // ç¬¬5ç»„ #001ï¼šå‘å/å‘å‰
  L5: { name: "å‘å", press: "#001P2500T2000!", release: "#001PDST!" },
  R5: { name: "å‘å‰", press: "#001P0500T2000!", release: "#001PDST!" },
  // ç¬¬6ç»„ #000ï¼šå·¦è½¬/å³è½¬ã€æ–°å¢æ ¸å¿ƒã€‘
  L6: { name: "å·¦è½¬", press: "#000P2500T2000!", release: "#000PDST!" },
  R6: { name: "å³è½¬", press: "#000P0500T2000!", release: "#000PDST!" },
  // åº•éƒ¨åŠŸèƒ½æŒ‰é’®
  G1: { name: "G1", press: "$DBT:1,1!", release: "" },
  G2: { name: "G2", press: "$DBT:2,1!", release: "" },
  G3: { name: "G3", press: "$DBT:3,1!", release: "" },
  G4: { name: "G4", press: "$DBT:4,1!", release: "" },
  STOP: { name: "åœæ­¢", press: "$DST!", release: "" },
  RESET: { name: "å¤ä½", press: "$RST!", release: "" }
};

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½é…ç½®ï¼Œæ— åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
let buttonConfigs = JSON.parse(localStorage.getItem("btnCfgV3")) || defaultConfigs;

// åˆå§‹åŒ–æ‰€æœ‰æŒ‰é’®ï¼ˆå«6ç»„æ»‘å—çš„12ä¸ªä¾§è¾¹æŒ‰é’®ï¼‰
function initButtons() {
  Object.keys(buttonConfigs).forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    const cfg = buttonConfigs[btnId];
    btn.innerText = cfg.name || btnId;
    // ç§»é™¤æ—§äº‹ä»¶ï¼Œé¿å…å åŠ 
    btn.removeEventListener('mousedown', handleBtnPress);
    btn.removeEventListener('mouseup', handleBtnRelease);
    btn.removeEventListener('touchstart', handleBtnPress);
    btn.removeEventListener('touchend', handleBtnRelease);
    // ç»‘å®šæ–°äº‹ä»¶
    btn.addEventListener('mousedown', handleBtnPress);
    btn.addEventListener('mouseup', handleBtnRelease);
    btn.addEventListener('touchstart', handleBtnPress, { passive: false });
    btn.addEventListener('touchend', handleBtnRelease, { passive: false });
  });
}

// æŒ‰é’®æŒ‰ä¸‹äº‹ä»¶ï¼šå‘é€æŒ‰ä¸‹æŒ‡ä»¤ï¼ˆä¿®å¤ï¼šå…ˆåˆ¤æ–­äº‹ä»¶å¯å–æ¶ˆå†é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼‰
function handleBtnPress(e) {
  // ä»…å½“äº‹ä»¶å¯å–æ¶ˆæ—¶ï¼Œæ‰æ‰§è¡ŒpreventDefaultï¼Œæ¶ˆé™¤æµè§ˆå™¨è­¦å‘Š
  if (e.cancelable) e.preventDefault();
  const btnId = e.target.id;
  const cfg = buttonConfigs[btnId];
  if (cfg && cfg.press) send(cfg.press);
}

// æŒ‰é’®æŠ¬èµ·äº‹ä»¶ï¼šå‘é€æŠ¬èµ·æŒ‡ä»¤ï¼ˆæ— åˆ™ä¸å‘ï¼‰ï¼ˆä¿®å¤ï¼šå…ˆåˆ¤æ–­äº‹ä»¶å¯å–æ¶ˆå†é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼‰
function handleBtnRelease(e) {
  // ä»…å½“äº‹ä»¶å¯å–æ¶ˆæ—¶ï¼Œæ‰æ‰§è¡ŒpreventDefaultï¼Œæ¶ˆé™¤æµè§ˆå™¨è­¦å‘Š
  if (e.cancelable) e.preventDefault();
  const btnId = e.target.id;
  const cfg = buttonConfigs[btnId];
  if (cfg && cfg.release) send(cfg.release);
}

// ã€æ ¸å¿ƒã€‘æ»‘å—æŒ‰ä¸‹äº‹ä»¶ï¼šæ ‡è®°æŒ‰ä½çŠ¶æ€ï¼Œç«‹å³æ‰§è¡Œçº§åˆ«åˆ¤æ–­å’ŒæŒ‡ä»¤å‘é€
function sliderDown(sliderId, sliderEl) {
  sliderHeld[sliderId] = true;
  judgeSliderLevel(sliderId, sliderEl);
}

// ã€æ ¸å¿ƒã€‘æ»‘å—æ‹–åŠ¨äº‹ä»¶ï¼šå®æ—¶å¸é™„åˆ°æœ€è¿‘çº§åˆ«ï¼Œæ›´æ–°æŒ‡ä»¤
function sliderMove(sliderId, sliderEl) {
  if (!sliderHeld[sliderId]) return;
  judgeSliderLevel(sliderId, sliderEl, true);
}

// ã€æ ¸å¿ƒã€‘æ»‘å—æŠ¬èµ·äº‹ä»¶ï¼šæ¸…é™¤å®šæ—¶å™¨ï¼Œå›å¼¹åˆ°ä¸­é—´ï¼ˆ3çº§ï¼‰ï¼Œä¸å‘é€æŒ‡ä»¤
function sliderUp(sliderId, sliderEl) {
  sliderHeld[sliderId] = false;
  // æ¸…é™¤å½“å‰æ»‘å—çš„å®šæ—¶å™¨ï¼Œåœæ­¢é‡å‘
  if (sliderTimers[sliderId]) {
    clearInterval(sliderTimers[sliderId]);
    delete sliderTimers[sliderId];
  }
  // ç«‹å³å›å¼¹åˆ°ä¸­é—´ä½ç½®ï¼ˆvalue=3ï¼‰ï¼Œæ— åŠ¨ç”»
  sliderEl.value = 3;
}

// ã€æ ¸å¿ƒã€‘åˆ¤æ–­æ»‘å—çº§åˆ«+è‡ªåŠ¨å¸é™„+è®¡ç®—æŒ‡ä»¤+å®šæ—¶é‡å‘
function judgeSliderLevel(sliderId, sliderEl, isMoving = false) {
  let currentVal = parseInt(sliderEl.value);
  // 7ä¸ªæ¡£ä½ï¼š0(å·¦3)ã€1(å·¦2)ã€2(å·¦1)ã€3(ä¸­é—´)ã€4(å³1)ã€5(å³2)ã€6(å³3)
  const levels = [0, 1, 2, 3, 4, 5, 6];
  // è‡ªåŠ¨å¸é™„åˆ°æœ€è¿‘çº§åˆ«
  const nearestLevel = levels.reduce((a, b) => Math.abs(b - currentVal) < Math.abs(a - currentVal) ? b : a);
  sliderEl.value = nearestLevel;

  // ä¸­é—´çº§åˆ«ï¼ˆ3ï¼‰ï¼šæ— æ“ä½œï¼Œæ¸…é™¤å®šæ—¶å™¨
  if (nearestLevel === 3) {
    if (sliderTimers[sliderId]) {
      clearInterval(sliderTimers[sliderId]);
      delete sliderTimers[sliderId];
    }
    return;
  }

  // éä¸­é—´çº§åˆ«ï¼šåŒ¹é…å¯¹åº”å·¦å³æŒ‰é’®IDï¼ˆL6/R6ä¸ºç¬¬6ç»„æ–°å¢ï¼‰
  const leftBtnId = `L${sliderId}`;
  const rightBtnId = `R${sliderId}`;
  const targetBtnId = nearestLevel < 3 ? leftBtnId : rightBtnId;
  const originalCmd = buttonConfigs[targetBtnId]?.press;
  
  // æ— æŒ‡ä»¤æˆ–è“ç‰™æœªè¿æ¥ï¼Œç›´æ¥è¿”å›
  if (!originalCmd || !bleChar) return;

  // è®¡ç®—å½“å‰çº§åˆ«ï¼ˆå·¦1/2/3 æˆ– å³1/2/3ï¼‰
  const level = nearestLevel < 3 ? 3 - nearestLevel : nearestLevel - 3;
  // æŒ‰çº§åˆ«è®¡ç®—æ–°æŒ‡ä»¤ï¼ˆTå€¼2/3/1/3å–æ•´ï¼‰
  const newCmd = calculateLevelCmd(originalCmd, level);
  if (!newCmd) return;

  // é¦–æ¬¡æŒ‰ä¸‹/æ‹–åŠ¨ï¼šç«‹å³å‘é€ä¸€æ¬¡æŒ‡ä»¤
  if (!isMoving || !sliderTimers[sliderId]) {
    send(newCmd);
  }

  // æå–Tå€¼ä½œä¸ºå®šæ—¶é‡å‘é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  const tMatch = newCmd.match(/T(\d+)!/);
  const interval = tMatch ? parseInt(tMatch[1]) : 2000;

  // æ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œåˆ›å»ºæ–°å®šæ—¶å™¨æŒ‰é—´éš”é‡å‘
  if (sliderTimers[sliderId]) clearInterval(sliderTimers[sliderId]);
  sliderTimers[sliderId] = setInterval(() => {
    if (sliderHeld[sliderId]) send(newCmd);
  }, interval);
}

// ã€æ ¸å¿ƒã€‘æŒ‰çº§åˆ«è®¡ç®—æŒ‡ä»¤ï¼š1çº§åŸTå€¼ï¼Œ2çº§TÃ—2/3å–æ•´ï¼Œ3çº§TÃ—1/3å–æ•´
function calculateLevelCmd(originalCmd, level) {
  // åŒ¹é…æŒ‡ä»¤æ ¼å¼ï¼š#XXX PXXX TXXX! æˆ– #XXXPTXXX!ï¼ˆå…¼å®¹æ— ç©ºæ ¼æƒ…å†µï¼‰
  const cmdMatch = originalCmd.match(/(#\d+P\d+T)(\d+)(!)/);
  if (!cmdMatch) return null;
  const [, prefix, tVal, suffix] = cmdMatch;
  const originalT = parseInt(tVal);

  let newT;
  switch (level) {
    case 1: newT = originalT; break;        // 1çº§ï¼šåŸå§‹Tå€¼
    case 2: newT = Math.floor(originalT * 2 / 3); break; // 2çº§ï¼šTÃ—2/3 å‘ä¸‹å–æ•´
    case 3: newT = Math.floor(originalT * 1 / 3); break; // 3çº§ï¼šTÃ—1/3 å‘ä¸‹å–æ•´
    default: return null;
  }

  // æ‹¼æ¥æ–°æŒ‡ä»¤ï¼Œä¿æŒåŸæ ¼å¼
  return `${prefix}${newT}${suffix}`;
}

// é…ç½®å¼¹çª—ï¼šæ‰“å¼€
function openConfig() {
  document.getElementById('configModal').style.display = "flex";
  loadCurrentConfig();
}

// é…ç½®å¼¹çª—ï¼šå…³é—­
function closeConfig() {
  document.getElementById('configModal').style.display = "none";
}

// åŠ è½½å½“å‰é€‰ä¸­æŒ‰é’®çš„é…ç½®
function loadCurrentConfig() {
  const id = document.getElementById('cfgId').value;
  const cfg = buttonConfigs[id] || { name: "", press: "", release: "" };
  document.getElementById('cfgName').value = cfg.name || "";
  document.getElementById('cfgPress').value = cfg.press || "";
  document.getElementById('cfgRelease').value = cfg.release || "";
}

// ä¿å­˜æŒ‰é’®é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
function saveConfig() {
  const id = document.getElementById('cfgId').value;
  buttonConfigs[id] = {
    name: document.getElementById('cfgName').value.trim(),
    press: document.getElementById('cfgPress').value.trim(),
    release: document.getElementById('cfgRelease').value.trim()
  };
  localStorage.setItem("btnCfgV3", JSON.stringify(buttonConfigs));
  initButtons(); // é‡æ–°åˆå§‹åŒ–æŒ‰é’®ï¼Œåº”ç”¨æ–°é…ç½®
  closeConfig();
}

// è“ç‰™BLEè¿æ¥æ ¸å¿ƒé€»è¾‘ï¼ˆUUIDï¼šffe0/ffe1ï¼‰
async function connectBLE() {
  const status = document.getElementById('statusInfo');
  try {
    const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const CHAR_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }],
      optionalServices: [SERVICE_UUID]
    });
    status.innerText = "è¿æ¥ä¸­...";
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    bleChar = await service.getCharacteristic(CHAR_UUID);
    status.innerText = "å·²è¿æ¥: " + device.name;
    status.style.color = "green";
  } catch (e) {
    status.innerText = "è¿æ¥å¤±è´¥: " + e.message;
    status.style.color = "red";
  }
}

// å‘é€æŒ‡ä»¤åˆ°è“ç‰™è®¾å¤‡
async function send(cmd) {
  if (!cmd || !bleChar) return;
  try {
    await bleChar.writeValue(new TextEncoder().encode(cmd));
  } catch (e) {
    console.error("æŒ‡ä»¤å‘é€å¤±è´¥:", e);
  }
}

// ã€æ ¸å¿ƒæ–°å¢ã€‘åŠ¨æ€å®šä½æ»‘å—ï¼šåŸºäºå®¹å™¨é«˜åº¦å’Œå…³èŠ‚ç™¾åˆ†æ¯”ï¼Œç²¾å‡†å¯¹é½
function positionSliders() {
  const mainContainer = document.querySelector('main');
  const bgImg = document.querySelector('.arm-bg');
  
  // å¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œä½¿ç”¨å›¾ç‰‡é«˜åº¦ï¼›å¦åˆ™ä½¿ç”¨å®¹å™¨é«˜åº¦
  let containerHeight;
  if (imageLoaded && bgImg.offsetHeight > 0) {
    containerHeight = bgImg.offsetHeight;
  } else {
    // ä½¿ç”¨å®¹å™¨è®¡ç®—çš„é«˜åº¦ï¼ˆåŸºäºå®½é«˜æ¯”ï¼‰
    containerHeight = mainContainer.clientHeight;
  }
  
  document.querySelectorAll('.slider-group').forEach(group => {
    const jointYPercent = parseFloat(group.dataset.jointY);
    // è®¡ç®—topå€¼ï¼šå…³èŠ‚ç™¾åˆ†æ¯”é«˜åº¦ - æ»‘å—è‡ªèº«é«˜åº¦çš„ä¸€åŠï¼Œå®ç°å‚ç›´å±…ä¸­å¯¹é½
    const top = (containerHeight * jointYPercent / 100) - (group.offsetHeight / 2);
    group.style.top = `${top}px`;
  });
}

// å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
function handleImageLoad(img) {
  console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
  imageLoaded = true;
  img.style.opacity = '0.9';
  // é‡æ–°å®šä½æ»‘å—
  positionSliders();
}

// é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ–
window.onload = () => {
  initButtons();
  // åˆå§‹åŒ–6ç»„æ»‘å—çš„çŠ¶æ€ï¼ˆ1-6å·æ»‘å—ï¼‰
  [1,2,3,4,5,6].forEach(id => {
    sliderHeld[id] = false;
    sliderTimers[id] = null;
  });
  
  // å›¾ç‰‡åŠ è½½äº‹ä»¶ç›‘å¬
  const bgImg = document.querySelector('.arm-bg');
  bgImg.addEventListener('load', function() {
    handleImageLoad(this);
  });
  
  // å¦‚æœå›¾ç‰‡å·²ç»ç¼“å­˜ï¼Œå¯èƒ½ä¸ä¼šè§¦å‘loadäº‹ä»¶
  if (bgImg.complete && bgImg.naturalHeight !== 0) {
    handleImageLoad(bgImg);
  }
  
  // é¦–æ¬¡å®šä½æ»‘å—
  setTimeout(positionSliders, 100);
};

// ç›‘å¬çª—å£ç¼©æ”¾ï¼Œé‡æ–°å®šä½æ»‘å—
window.addEventListener('resize', positionSliders);
</script>

</body>
</html>
