<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>BLE æœºæ¢°è‡‚æ§åˆ¶ - 6ç»„æ»‘å—ç²¾å‡†å¯¹é½ç‰ˆ</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f5f5f5;
  user-select: none;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: #ffffff;
  box-shadow: 0 1px 4px rgba(0,0,0,.1);
}

header button {
  border: none;
  background: #eee;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}
header button:active, header button.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}
header button#bleConnectBtn.blink {
  animation: blink 1s step-end infinite;
}
header button#bleConnectBtn.connected {
  background: #2196f3 !important;
  color: #ffffff !important;
}
@keyframes blink {
  0% { background: #eee; color: #000; }
  50% { background: #ff4444; color: #ffffff; }
  100% { background: #eee; color: #000; }
}

.label-btn {
  width: 55px;
  height: 32px;
  border: none;
  background: #3b82f6;
  color: white;
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}
.label-btn:active, .label-btn.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}
/* ç¦ç”¨çŠ¶æ€æ ·å¼ */
.label-btn.disabled, footer button.disabled, header button:not(#bleConnectBtn).disabled {
  background: #94a3b8 !important;
  cursor: not-allowed;
  opacity: 0.7;
  pointer-events: none; /* å…³é”®ä¿®å¤ï¼šç¦ç”¨ç‚¹å‡»äº‹ä»¶ */
}
.slider-group input[type="range"].disabled {
  pointer-events: none;
  opacity: 0.7;
}

footer {
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  max-width: 600px;
  margin: 20px auto 10px;
  width: 100%;
  box-sizing: border-box;
}
footer button {
  padding: 15px 10px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #6366f1;
  color: white;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}
footer button.secondary {
  background: #64748b;
}
footer button:active, footer button.tap-active,
footer button.secondary:active, footer button.secondary.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}

main {
  position: relative;
  padding: 10px;
  max-width: 600px;
  margin: 0 auto;
  height: calc(100vw * 1.302);
  max-height: calc(600px * 1.302);
  min-height: 400px;
  width: 100%;
  box-sizing: border-box;
  overflow: hidden;
  background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
  border-radius: 8px;
}

.arm-bg {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.9;
  border-radius: 8px;
  margin: 0 auto;
  background: transparent;
}

.slider-group {
  position: absolute;
  left: 5%;
  right: 5%;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.8);
  padding: 6px 10px;
  border-radius: 25px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 10;
}

.slider-group input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  border-radius: 3px;
  background: #e2e8f0;
  outline: none;
  margin: 0;
}
.slider-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #3b82f6;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.1s ease;
}
.slider-group input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #3b82f6;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.1s ease;
}

#configModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#configBox {
  background: white;
  padding: 20px;
  width: 85%;
  max-width: 400px;
  border-radius: 12px;
  max-height: 90vh;
  overflow-y: auto;
}

#configBox label {
  font-size: 14px;
  display: block;
  margin-top: 12px;
  color: #666;
}

#configBox input, #configBox select {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-sizing: border-box;
}

.modal-btns {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.modal-btns button {
  flex: 1;
  padding: 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}

.btn-save { background: #3b82f6; color: white; }
.btn-close { background: #eee; color: #333; }
.btn-save:active, .btn-save.tap-active,
.btn-close:active, .btn-close.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}

#statusInfo {
  font-size: 12px;
  color: #666;
  text-align: center;
  margin-top: 5px;
  height: 15px;
  width: 100%;
}
</style>
</head>

<body>

<header>
  <button onclick="openConfig()">âš™ é…ç½®</button>
  <div style="font-weight: bold;">æœºæ¢°è‡‚æ§åˆ¶ç³»ç»Ÿ</div>
  <button id="bleConnectBtn" onclick="connectBLE()">ğŸ”µ è¿æ¥è“ç‰™</button>
</header>

<div id="statusInfo">æœªè¿æ¥è“ç‰™</div>

<main>
  <img class="arm-bg" src="jxb.jpg" onerror="handleImageError(this)" />
  <div class="slider-group s1" data-joint-y="12">
    <button class="label-btn" id="L1">å¼ å¼€</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="1" onmousedown="sliderDown(1, this)" ontouchstart="sliderDown(1, this)" onmouseup="sliderUp(1, this)" ontouchend="sliderUp(1, this)" oninput="sliderMove(1, this)">
    <button class="label-btn" id="R1">é—­åˆ</button>
  </div>
  <div class="slider-group s2" data-joint-y="27.5">
    <button class="label-btn" id="L2">å·¦è½¬</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="2" onmousedown="sliderDown(2, this)" ontouchstart="sliderDown(2, this)" onmouseup="sliderUp(2, this)" ontouchend="sliderUp(2, this)" oninput="sliderMove(2, this)">
    <button class="label-btn" id="R2">å³è½¬</button>
  </div>
  <div class="slider-group s3" data-joint-y="42.8">
    <button class="label-btn" id="L3">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="3" onmousedown="sliderDown(3, this)" ontouchstart="sliderDown(3, this)" onmouseup="sliderUp(3, this)" ontouchend="sliderUp(3, this)" oninput="sliderMove(3, this)">
    <button class="label-btn" id="R3">å‘å‰</button>
  </div>
  <div class="slider-group s4" data-joint-y="58">
    <button class="label-btn" id="L4">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="4" onmousedown="sliderDown(4, this)" ontouchstart="sliderDown(4, this)" onmouseup="sliderUp(4, this)" ontouchend="sliderUp(4, this)" oninput="sliderMove(4, this)">
    <button class="label-btn" id="R4">å‘å‰</button>
  </div>
  <div class="slider-group s5" data-joint-y="73.2">
    <button class="label-btn" id="L5">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="5" onmousedown="sliderDown(5, this)" ontouchstart="sliderDown(5, this)" onmouseup="sliderUp(5, this)" ontouchend="sliderUp(5, this)" oninput="sliderMove(5, this)">
    <button class="label-btn" id="R5">å‘å‰</button>
  </div>
  <div class="slider-group s6" data-joint-y="88.7">
    <button class="label-btn" id="L6">å·¦è½¬</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="6" onmousedown="sliderDown(6, this)" ontouchstart="sliderDown(6, this)" onmouseup="sliderUp(6, this)" ontouchend="sliderUp(6, this)" oninput="sliderMove(6, this)">
    <button class="label-btn" id="R6">å³è½¬</button>
  </div>
</main>

<footer>
  <button id="G1">G1</button>
  <button id="G2">G2</button>
  <button id="G3">G3</button>
  <button id="G4">G4</button>
  <button class="secondary" id="STOP">åœæ­¢</button>
  <button class="secondary" id="RESET">å¤ä½</button>
</footer>

<div id="configModal">
  <div id="configBox">
    <h3 style="margin:0">åŠŸèƒ½é…ç½®</h3>
    <label>é€‰æ‹©æŒ‰é’®åºå·</label>
    <select id="cfgId" onchange="loadCurrentConfig()">
      <optgroup label="æ»‘å—ä¾§è¾¹æŒ‰é’®ã€6ç»„å®Œæ•´ã€‘">
        <option value="L1">æ»‘å—1-å·¦(å¼ å¼€)</option><option value="R1">æ»‘å—1-å³(é—­åˆ)</option>
        <option value="L2">æ»‘å—2-å·¦(å·¦è½¬)</option><option value="R2">æ»‘å—2-å³(å³è½¬)</option>
        <option value="L3">æ»‘å—3-å·¦(å‘å)</option><option value="R3">æ»‘å—3-å³(å‘å‰)</option>
        <option value="L4">æ»‘å—4-å·¦(å‘å)</option><option value="R4">æ»‘å—4-å³(å‘å‰)</option>
        <option value="L5">æ»‘å—5-å·¦(å‘å)</option><option value="R5">æ»‘å—5-å³(å‘å‰)</option>
        <option value="L6">æ»‘å—6-å·¦(å·¦è½¬)</option><option value="R6">æ»‘å—6-å³(å³è½¬)</option>
      </optgroup>
      <optgroup label="åº•éƒ¨åŠŸèƒ½æŒ‰é’®">
        <option value="G1">æŒ‰é’® G1</option><option value="G2">æŒ‰é’® G2</option>
        <option value="G3">æŒ‰é’® G3</option><option value="G4">æŒ‰é’® G4</option>
        <option value="STOP">åœæ­¢æŒ‰é’®</option><option value="RESET">å¤ä½æŒ‰é’®</option>
      </optgroup>
    </select>
    <label>æŒ‰é’®æ˜¾ç¤ºåç§°</label>
    <input id="cfgName">
    <label>æŒ‰ä¸‹å‘½ä»¤</label>
    <input id="cfgPress">
    <label>æŠ¬èµ·å‘½ä»¤ (å¯é€‰)</label>
    <input id="cfgRelease">
    <label>æŠ¬èµ·æŒ‡ä»¤å»¶è¿Ÿ(æ¯«ç§’) <span style="color:#999">(é»˜è®¤200)</span></label>
    <input id="cfgDelay" type="number" min="0" placeholder="200">
    <div class="modal-btns">
      <button class="btn-save" onclick="saveConfig()">ä¿å­˜</button>
      <button class="btn-close" onclick="closeConfig()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡æ˜ç¡®ç»‘å®šåˆ°windowï¼Œé¿å…ä½œç”¨åŸŸå†²çª
window.bleChar = null;
window.bleDevice = null; 
let sliderTimers = {};
let sliderHeld = {};
let imageLoaded = false;
// è®°å½•å½“å‰æ»‘å—è§¦å‘çš„æŒ‰é’®IDï¼Œç”¨äºå›å¼¹æ—¶å‘é€æŠ¬èµ·æŒ‡ä»¤
let sliderActiveBtn = {};
// æ“ä½œé”å®šçŠ¶æ€å’Œå»¶è¿Ÿå®šæ—¶å™¨
let isOperationLocked = false;
let releaseTimers = {};
// é»˜è®¤å»¶è¿Ÿæ—¶é—´
const DEFAULT_DELAY = 200;
const bleBtn = document.getElementById('bleConnectBtn');

document.addEventListener('DOMContentLoaded', function() {
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(btn => {
    btn.addEventListener('touchstart', function() {
      // é”å®šçŠ¶æ€ä¸‹ä¸è§¦å‘ç‚¹å‡»æ•ˆæœ
      if (!isOperationLocked) {
        this.classList.add('tap-active');
      }
    }, { passive: true });
    btn.addEventListener('touchend', function() {
      this.classList.remove('tap-active');
    });
    btn.addEventListener('touchmove', function(e) {
      const rect = this.getBoundingClientRect();
      const x = e.touches[0].clientX;
      const y = e.touches[0].clientY;
      if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        this.classList.remove('tap-active');
      }
    }, { passive: true });
    btn.addEventListener('touchcancel', function() {
      this.classList.remove('tap-active');
    });
    btn.addEventListener('mousedown', function() {
      if (!isOperationLocked) {
        this.classList.add('tap-active');
      }
    });
    btn.addEventListener('mouseup', function() {
      this.classList.remove('tap-active');
    });
    btn.addEventListener('mouseleave', function() {
      this.classList.remove('tap-active');
    });
  });
});

// æ ¸å¿ƒä¿®å¤ï¼šé‡æ„é”å®š/è§£é”å‡½æ•°ï¼Œç¡®ä¿æ ·å¼å’ŒçŠ¶æ€åŒæ­¥
function lockOperations(lock = true) {
  if (lock === isOperationLocked) return; // é¿å…é‡å¤æ“ä½œ
  
  isOperationLocked = lock;
  
  // é”å®š/è§£é”æ‰€æœ‰æŒ‰é’®ï¼ˆé™¤è“ç‰™è¿æ¥æŒ‰é’®ï¼‰
  const allControlButtons = document.querySelectorAll('.label-btn, footer button, header button:not(#bleConnectBtn)');
  allControlButtons.forEach(btn => {
    if (lock) {
      btn.classList.add('disabled');
    } else {
      btn.classList.remove('disabled');
    }
  });
  
  // é”å®š/è§£é”æ‰€æœ‰æ»‘å—
  const allSliders = document.querySelectorAll('.slider-group input[type="range"]');
  allSliders.forEach(slider => {
    if (lock) {
      slider.classList.add('disabled');
    } else {
      slider.classList.remove('disabled');
    }
  });
  
  console.log(`æ“ä½œæ§ä»¶${lock ? 'é”å®š' : 'è§£é”'}`);
}

// æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶è§£é”å‡½æ•°ï¼Œç”¨äºå¼‚å¸¸æƒ…å†µæ¢å¤
function forceUnlockOperations() {
  isOperationLocked = false;
  // ç§»é™¤æ‰€æœ‰ç¦ç”¨æ ·å¼
  document.querySelectorAll('.disabled').forEach(el => {
    el.classList.remove('disabled');
  });
  console.log('å¼ºåˆ¶è§£é”æ‰€æœ‰æ“ä½œæ§ä»¶');
}

function handleImageError(img) {
  console.log('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å¸ƒå±€');
  imageLoaded = false;
  img.style.opacity = '0';
  positionSliders();
}

const defaultConfigs = {
  L1: { name: "å¼ å¼€", press: "#005P0500T2000!", release: "#005PDST!", delay: DEFAULT_DELAY },
  R1: { name: "é—­åˆ", press: "#005P2500T2000!", release: "#005PDST!", delay: DEFAULT_DELAY },
  L2: { name: "å·¦è½¬", press: "#004P0500T2000!", release: "#004PDST!", delay: DEFAULT_DELAY },
  R2: { name: "å³è½¬", press: "#004P2500T2000!", release: "#004PDST!", delay: DEFAULT_DELAY },
  L3: { name: "å‘å", press: "#003P0500T2000!", release: "#003PDST!", delay: DEFAULT_DELAY },
  R3: { name: "å‘å‰", press: "#003P2500T2000!", release: "#003PDST!", delay: DEFAULT_DELAY },
  L4: { name: "å‘å", press: "#002P0500T2000!", release: "#002PDST!", delay: DEFAULT_DELAY },
  R4: { name: "å‘å‰", press: "#002P2500T2000!", release: "#002PDST!", delay: DEFAULT_DELAY },
  L5: { name: "å‘å", press: "#001P2500T2000!", release: "#001PDST!", delay: DEFAULT_DELAY },
  R5: { name: "å‘å‰", press: "#001P0500T2000!", release: "#001PDST!", delay: DEFAULT_DELAY },
  L6: { name: "å·¦è½¬", press: "#000P2500T2000!", release: "#000PDST!", delay: DEFAULT_DELAY },
  R6: { name: "å³è½¬", press: "#000P0500T2000!", release: "#000PDST!", delay: DEFAULT_DELAY },
  G1: { name: "G1", press: "$DBT:1,1!", release: "", delay: DEFAULT_DELAY },
  G2: { name: "G2", press: "$DBT:2,1!", release: "", delay: DEFAULT_DELAY },
  G3: { name: "G3", press: "$DBT:3,1!", release: "", delay: DEFAULT_DELAY },
  G4: { name: "G4", press: "$DBT:4,1!", release: "", delay: DEFAULT_DELAY },
  STOP: { name: "åœæ­¢", press: "$DST!", release: "", delay: DEFAULT_DELAY },
  RESET: { name: "å¤ä½", press: "$RST!", release: "", delay: DEFAULT_DELAY }
};

let buttonConfigs = JSON.parse(localStorage.getItem("btnCfgV3")) || defaultConfigs;

function initButtons() {
  Object.keys(buttonConfigs).forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    const cfg = buttonConfigs[btnId];
    btn.innerText = cfg.name || btnId;
    btn.removeEventListener('mousedown', handleBtnPress);
    btn.removeEventListener('mouseup', handleBtnRelease);
    btn.removeEventListener('touchstart', handleBtnPress);
    btn.removeEventListener('touchend', handleBtnRelease);
    btn.addEventListener('mousedown', handleBtnPress);
    btn.addEventListener('mouseup', handleBtnRelease);
    btn.addEventListener('touchstart', handleBtnPress, { passive: false });
    btn.addEventListener('touchend', handleBtnRelease, { passive: false });
  });
}

// æ ¸å¿ƒä¿®å¤ï¼šä¼˜åŒ–æŒ‰é’®æŒ‰ä¸‹é€»è¾‘ï¼Œç¡®ä¿é”å®šå¯é 
function handleBtnPress(e) {
  // é”å®šçŠ¶æ€ä¸‹ä¸å¤„ç†
  if (isOperationLocked) {
    e.preventDefault();
    return;
  }
  
  if (e.cancelable) e.preventDefault();
  const btnId = e.target.id;
  const cfg = buttonConfigs[btnId];
  
  // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿå®šæ—¶å™¨
  if (releaseTimers[btnId]) {
    clearTimeout(releaseTimers[btnId]);
    delete releaseTimers[btnId];
  }
  
  if (cfg && cfg.press) {
    // ç«‹å³é”å®šæ“ä½œ
    lockOperations(true);
    // å‘é€æŒ‰ä¸‹æŒ‡ä»¤
    send(cfg.press).catch(err => {
      console.error('å‘é€æŒ‰ä¸‹æŒ‡ä»¤å¤±è´¥:', err);
      // å‘é€å¤±è´¥æ—¶ç«‹å³è§£é”
      forceUnlockOperations();
    });
  }
}

// æ ¸å¿ƒä¿®å¤ï¼šé‡æ„æŒ‰é’®æŠ¬èµ·é€»è¾‘ï¼Œç¡®ä¿å»¶è¿Ÿåå¿…è§£é”
function handleBtnRelease(e) {
  if (isOperationLocked && !releaseTimers[e.target.id]) {
    e.preventDefault();
    return;
  }
  
  if (e.cancelable) e.preventDefault();
  const btnId = e.target.id;
  const cfg = buttonConfigs[btnId];
  
  // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿå®šæ—¶å™¨
  if (releaseTimers[btnId]) {
    clearTimeout(releaseTimers[btnId]);
    delete releaseTimers[btnId];
  }
  
  if (cfg && cfg.release) {
    // è·å–å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤200ms
    const delay = cfg.delay || DEFAULT_DELAY;
    
    console.log(`ã€æŒ‰é’®${btnId}ã€‘å°†å»¶è¿Ÿ${delay}mså‘é€æŠ¬èµ·æŒ‡ä»¤`);
    
    // å»¶è¿Ÿå‘é€æŠ¬èµ·æŒ‡ä»¤
    releaseTimers[btnId] = setTimeout(() => {
      try {
        send(cfg.release);
        console.log(`ã€æŒ‰é’®${btnId}ã€‘å»¶è¿Ÿ${delay}mså‘é€æŠ¬èµ·æŒ‡ä»¤æˆåŠŸ`);
      } catch (err) {
        console.error(`ã€æŒ‰é’®${btnId}ã€‘å‘é€æŠ¬èµ·æŒ‡ä»¤å¤±è´¥:`, err);
      } finally {
        // æ— è®ºå‘é€æˆåŠŸä¸å¦ï¼Œéƒ½è§£é”
        forceUnlockOperations();
        delete releaseTimers[btnId];
      }
    }, delay);
  } else {
    // æ— æŠ¬èµ·æŒ‡ä»¤æ—¶ç«‹å³è§£é”
    forceUnlockOperations();
  }
}

// æ ¸å¿ƒä¿®å¤ï¼šä¼˜åŒ–æ»‘å—æŒ‰ä¸‹é€»è¾‘
function sliderDown(sliderId, sliderEl) {
  // é”å®šçŠ¶æ€ä¸‹ä¸å¤„ç†
  if (isOperationLocked) return;
  
  sliderHeld[sliderId] = true;
  
  // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿå®šæ—¶å™¨
  const timerKey = `slider_${sliderId}`;
  if (releaseTimers[timerKey]) {
    clearTimeout(releaseTimers[timerKey]);
    delete releaseTimers[timerKey];
  }
  
  // ç«‹å³é”å®šæ“ä½œ
  lockOperations(true);
  judgeSliderLevel(sliderId, sliderEl);
}

function sliderMove(sliderId, sliderEl) {
  if (!sliderHeld[sliderId] || isOperationLocked) return;
  judgeSliderLevel(sliderId, sliderEl, true);
}

function sliderUp(sliderId, sliderEl) {
  sliderHeld[sliderId] = false;
  
  if (sliderTimers[sliderId]) {
    clearInterval(sliderTimers[sliderId]);
    delete sliderTimers[sliderId];
  }
  
  // æ»‘å—å›å¼¹åˆ°ä¸­é—´ä½ç½®æ—¶å»¶è¿Ÿå‘é€æŠ¬èµ·æŒ‡ä»¤
  sendSliderReleaseCmd(sliderId);
  sliderEl.value = 3;
  
  // æ¸…ç©ºå½“å‰æ¿€æ´»çš„æŒ‰é’®è®°å½•
  delete sliderActiveBtn[sliderId];
}

function judgeSliderLevel(sliderId, sliderEl, isMoving = false) {
  let currentVal = parseInt(sliderEl.value);
  const levels = [0, 1, 2, 3, 4, 5, 6];
  const nearestLevel = levels.reduce((a, b) => Math.abs(b - currentVal) < Math.abs(a - currentVal) ? b : a);
  sliderEl.value = nearestLevel;

  if (nearestLevel === 3) {
    if (sliderTimers[sliderId]) {
      clearInterval(sliderTimers[sliderId]);
      delete sliderTimers[sliderId];
    }
    // æ»‘å—å›åˆ°ä¸­é—´ä½ç½®æ—¶å»¶è¿Ÿå‘é€æŠ¬èµ·æŒ‡ä»¤
    sendSliderReleaseCmd(sliderId);
    // æ¸…ç©ºå½“å‰æ¿€æ´»çš„æŒ‰é’®è®°å½•
    delete sliderActiveBtn[sliderId];
    return;
  }

  const leftBtnId = `L${sliderId}`;
  const rightBtnId = `R${sliderId}`;
  const targetBtnId = nearestLevel < 3 ? leftBtnId : rightBtnId;
  // è®°å½•å½“å‰æ¿€æ´»çš„æŒ‰é’®ID
  sliderActiveBtn[sliderId] = targetBtnId;
  
  const originalCmd = buttonConfigs[targetBtnId]?.press;
  
  if (!originalCmd || !window.bleChar) return;

  const level = nearestLevel < 3 ? 3 - nearestLevel : nearestLevel - 3;
  const newCmd = calculateLevelCmd(originalCmd, level);
  if (!newCmd) return;

  if (!isMoving || !sliderTimers[sliderId]) {
    send(newCmd).catch(err => {
      console.error(`ã€æ»‘å—${sliderId}ã€‘å‘é€æŒ‡ä»¤å¤±è´¥:`, err);
      forceUnlockOperations();
    });
  }

  const tMatch = newCmd.match(/T(\d+)!/);
  const interval = tMatch ? parseInt(tMatch[1]) : 2000;

  if (sliderTimers[sliderId]) clearInterval(sliderTimers[sliderId]);
  sliderTimers[sliderId] = setInterval(() => {
    if (sliderHeld[sliderId]) send(newCmd);
  }, interval);
}

// æ ¸å¿ƒä¿®å¤ï¼šé‡æ„æ»‘å—æŠ¬èµ·æŒ‡ä»¤å‘é€é€»è¾‘ï¼Œç¡®ä¿å»¶è¿Ÿåå¿…è§£é”
function sendSliderReleaseCmd(sliderId) {
  const activeBtnId = sliderActiveBtn[sliderId];
  const timerKey = `slider_${sliderId}`;
  
  // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿå®šæ—¶å™¨
  if (releaseTimers[timerKey]) {
    clearTimeout(releaseTimers[timerKey]);
    delete releaseTimers[timerKey];
  }
  
  if (!activeBtnId) {
    // æ— æ¿€æ´»æŒ‰é’®æ—¶ç«‹å³è§£é”
    forceUnlockOperations();
    return;
  }
  
  const cfg = buttonConfigs[activeBtnId];
  if (cfg && cfg.release) {
    // è·å–å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤200ms
    const delay = cfg.delay || DEFAULT_DELAY;
    
    console.log(`ã€æ»‘å—${sliderId}ã€‘å°†å»¶è¿Ÿ${delay}mså‘é€æŠ¬èµ·æŒ‡ä»¤`);
    
    // å»¶è¿Ÿå‘é€æŠ¬èµ·æŒ‡ä»¤
    releaseTimers[timerKey] = setTimeout(() => {
      try {
        send(cfg.release);
        console.log(`ã€æ»‘å—${sliderId}ã€‘å»¶è¿Ÿ${delay}mså‘é€æŠ¬èµ·æŒ‡ä»¤æˆåŠŸ`);
      } catch (err) {
        console.error(`ã€æ»‘å—${sliderId}ã€‘å‘é€æŠ¬èµ·æŒ‡ä»¤å¤±è´¥:`, err);
      } finally {
        // æ— è®ºå‘é€æˆåŠŸä¸å¦ï¼Œéƒ½å¼ºåˆ¶è§£é”
        forceUnlockOperations();
        delete releaseTimers[timerKey];
      }
    }, delay);
  } else {
    // æ— æŠ¬èµ·æŒ‡ä»¤æ—¶ç«‹å³è§£é”
    forceUnlockOperations();
  }
}

function calculateLevelCmd(originalCmd, level) {
  const cmdMatch = originalCmd.match(/(#\d+P\d+T)(\d+)(!)/);
  if (!cmdMatch) return null;
  const [, prefix, tVal, suffix] = cmdMatch;
  const originalT = parseInt(tVal);

  let newT;
  switch (level) {
    case 1: newT = originalT; break;
    case 2: newT = Math.floor(originalT * 2 / 3); break;
    case 3: newT = Math.floor(originalT * 1 / 3); break;
    default: return null;
  }

  return `${prefix}${newT}${suffix}`;
}

function openConfig() {
  document.getElementById('configModal').style.display = "flex";
  loadCurrentConfig();
}

function closeConfig() {
  document.getElementById('configModal').style.display = "none";
}

function loadCurrentConfig() {
  const id = document.getElementById('cfgId').value;
  const cfg = buttonConfigs[id] || { name: "", press: "", release: "", delay: DEFAULT_DELAY };
  document.getElementById('cfgName').value = cfg.name || "";
  document.getElementById('cfgPress').value = cfg.press || "";
  document.getElementById('cfgRelease').value = cfg.release || "";
  document.getElementById('cfgDelay').value = cfg.delay || DEFAULT_DELAY;
}

function saveConfig() {
  const id = document.getElementById('cfgId').value;
  const delayValue = document.getElementById('cfgDelay').value;
  // å¤„ç†å»¶è¿Ÿå€¼ï¼Œä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
  const delay = delayValue ? parseInt(delayValue) : DEFAULT_DELAY;
  
  buttonConfigs[id] = {
    name: document.getElementById('cfgName').value.trim(),
    press: document.getElementById('cfgPress').value.trim(),
    release: document.getElementById('cfgRelease').value.trim(),
    delay: delay >= 0 ? delay : DEFAULT_DELAY // ç¡®ä¿å»¶è¿Ÿå€¼éè´Ÿ
  };
  
  localStorage.setItem("btnCfgV3", JSON.stringify(buttonConfigs));
  initButtons();
  closeConfig();
}

// æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢ä¸ºå¯å†™å…¥çš„ffe2ç‰¹å¾å€¼UUID
async function connectBLE() {
  const status = document.getElementById('statusInfo');
  bleBtn.classList.remove('connected');
  bleBtn.classList.add('blink');
  bleBtn.disabled = true;

  // é‡ç½®è“ç‰™çŠ¶æ€
  window.bleChar = null;
  window.bleDevice = null;

  try {
    const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    // å…³é”®ä¿®æ”¹ï¼šffe1 â†’ ffe2ï¼ˆå¯å†™å…¥ç‰¹å¾å€¼ï¼‰
    const CHAR_UUID = '0000ffe2-0000-1000-8000-00805f9b34fb';
    
    // 1. è¯·æ±‚è®¾å¤‡
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }],
      optionalServices: [SERVICE_UUID]
    });
    window.bleDevice = device; // ä¿å­˜è®¾å¤‡å®ä¾‹åˆ°window
    status.innerText = "è¿æ¥ä¸­...";

    // ç›‘å¬è®¾å¤‡æ–­å¼€äº‹ä»¶
    device.addEventListener('gattserverdisconnected', () => {
      window.bleChar = null;
      bleBtn.classList.remove('blink', 'connected');
      bleBtn.innerText = "ğŸ”µ è¿æ¥è“ç‰™";
      status.innerText = "è“ç‰™å·²æ–­å¼€";
      status.style.color = "orange";
      // è“ç‰™æ–­å¼€æ—¶å¼ºåˆ¶è§£é”
      forceUnlockOperations();
    });

    // 2. è¿æ¥GATTæœåŠ¡å™¨
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    const characteristic = await service.getCharacteristic(CHAR_UUID);

    // 3. æ ¡éªŒç‰¹å¾å€¼å†™å…¥æƒé™ï¼ˆåŒé‡ç¡®è®¤ï¼‰
    if (!characteristic.properties.write && !characteristic.properties.writeWithoutResponse) {
      throw new Error("ç‰¹å¾å€¼ä¸æ”¯æŒå†™å…¥æ“ä½œ");
    }

    // 4. å»¶è¿Ÿç¡®è®¤ï¼Œç¡®ä¿ç‰¹å¾å€¼å°±ç»ª
    await new Promise(resolve => setTimeout(resolve, 200));
    
    window.bleChar = characteristic;
    bleBtn.classList.remove('blink');
    bleBtn.classList.add('connected');
    bleBtn.innerText = "ğŸ”µ å·²è¿è“ç‰™";
    status.innerText = "å·²è¿æ¥: " + device.name;
    status.style.color = "green";
    console.log("ã€æˆåŠŸã€‘è¿æ¥è“ç‰™ï¼Œç‰¹å¾å€¼UUIDï¼š", characteristic.uuid);
    console.log("ã€æˆåŠŸã€‘å†™å…¥æƒé™ï¼š", characteristic.properties.write, characteristic.properties.writeWithoutResponse);
  } catch (e) {
    bleBtn.classList.remove('blink');
    bleBtn.innerText = "ğŸ”µ è¿æ¥è“ç‰™";
    status.innerText = "è¿æ¥å¤±è´¥: " + e.message;
    status.style.color = "red";
    console.error("è“ç‰™è¿æ¥å¤±è´¥:", e);
    // è¿æ¥å¤±è´¥æ—¶å¼ºåˆ¶è§£é”
    forceUnlockOperations();
  } finally {
    bleBtn.disabled = false;
  }
}

// æ ¸å¿ƒä¿®å¤ï¼šä¿®æ”¹sendå‡½æ•°ä¸ºasyncå¹¶è¿”å›Promiseï¼Œå¢åŠ é”™è¯¯å¤„ç†
async function send(cmd) {
  const status = document.getElementById('statusInfo');
  // å¼ºåˆ¶è·å–å…¨å±€å˜é‡
  const bleChar = window.bleChar;
  const bleDevice = window.bleDevice;
  
  // 1. åŸºç¡€æ ¡éªŒ
  if (!cmd) {
    console.warn("ç©ºæŒ‡ä»¤ï¼Œè·³è¿‡å‘é€");
    return Promise.resolve();
  }
  
  // 2. æ ¡éªŒè“ç‰™è¿æ¥çŠ¶æ€
  if (!bleChar || !bleDevice || !bleDevice.gatt.connected) {
    status.innerText = "è“ç‰™æœªè¿æ¥ï¼Œæ— æ³•å‘é€æŒ‡ä»¤";
    status.style.color = "red";
    console.error("è“ç‰™æœªè¿æ¥ï¼šbleChar=", bleChar, "bleDevice.connected=", bleDevice?.gatt?.connected);
    return Promise.reject(new Error("è“ç‰™æœªè¿æ¥"));
  }

  try {
    const data = new TextEncoder().encode(cmd);
    // 3. ä¼˜å…ˆä½¿ç”¨æ— å“åº”å†™å…¥ï¼ˆBLEè®¾å¤‡æ›´å…¼å®¹ï¼‰
    if (bleChar.writeValueWithoutResponse) {
      await bleChar.writeValueWithoutResponse(data);
    } else if (bleChar.writeValue) {
      await bleChar.writeValue(data);
    } else {
      throw new Error("æµè§ˆå™¨ä¸æ”¯æŒBLEå†™å…¥æ“ä½œ");
    }

    // æ›´æ–°çŠ¶æ€æç¤º
    status.innerText = `å‘é€æˆåŠŸ: ${cmd.substring(0, 10)}...`;
    status.style.color = "green";
    // 2ç§’åæ¢å¤çŠ¶æ€
    setTimeout(() => {
      if (bleDevice && bleDevice.gatt.connected) {
        status.innerText = "å·²è¿æ¥: " + bleDevice.name;
      }
    }, 2000);
    console.log("ã€æˆåŠŸã€‘å‘é€æŒ‡ä»¤ï¼š", cmd);
    return Promise.resolve();
  } catch (e) {
    status.innerText = `å‘é€å¤±è´¥: ${e.message}`;
    status.style.color = "red";
    console.error("æŒ‡ä»¤å‘é€å¤±è´¥:", e);
    
    // è‡ªåŠ¨é‡è¿é€»è¾‘
    if (e.message.includes("GATT operation not permitted") && bleDevice) {
      try {
        await bleDevice.gatt.connect();
        status.innerText = "å·²é‡è¿è“ç‰™ï¼Œå¯é‡è¯•å‘é€";
        console.log("ã€æˆåŠŸã€‘è‡ªåŠ¨é‡è¿è“ç‰™");
      } catch (reconnectErr) {
        status.innerText = "é‡è¿å¤±è´¥ï¼Œè¯·é‡æ–°è¿æ¥è“ç‰™";
        window.bleChar = null;
        bleBtn.classList.remove('connected');
        bleBtn.innerText = "ğŸ”µ è¿æ¥è“ç‰™";
        console.error("é‡è¿å¤±è´¥:", reconnectErr);
      }
    }
    
    return Promise.reject(e);
  }
}

function positionSliders() {
  const mainContainer = document.querySelector('main');
  const bgImg = document.querySelector('.arm-bg');
  
  let containerHeight;
  if (imageLoaded && bgImg.offsetHeight > 0) {
    containerHeight = bgImg.offsetHeight;
  } else {
    containerHeight = mainContainer.clientHeight;
  }
  
  document.querySelectorAll('.slider-group').forEach(group => {
    const jointYPercent = parseFloat(group.dataset.jointY);
    const top = (containerHeight * jointYPercent / 100) - (group.offsetHeight / 2);
    group.style.top = `${top}px`;
  });
}

function handleImageLoad(img) {
  console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
  imageLoaded = true;
  img.style.opacity = '0.9';
  positionSliders();
}

// æ ¸å¿ƒä¿®å¤ï¼šé¡µé¢åŠ è½½æ—¶ç¡®ä¿è§£é”çŠ¶æ€
window.onload = () => {
  // åˆå§‹åŒ–æ—¶å¼ºåˆ¶è§£é”
  forceUnlockOperations();
  
  initButtons();
  [1,2,3,4,5,6].forEach(id => {
    sliderHeld[id] = false;
    sliderTimers[id] = null;
    sliderActiveBtn[id] = null; // åˆå§‹åŒ–æ¿€æ´»æŒ‰é’®è®°å½•
  });
  
  const bgImg = document.querySelector('.arm-bg');
  bgImg.addEventListener('load', function() {
    handleImageLoad(this);
  });
  
  if (bgImg.complete && bgImg.naturalHeight !== 0) {
    handleImageLoad(bgImg);
  }
  
  setTimeout(positionSliders, 100);
};

// æ ¸å¿ƒä¿®å¤ï¼šé¡µé¢å¸è½½/éšè—æ—¶å¼ºåˆ¶è§£é”å¹¶æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
window.addEventListener('beforeunload', () => {
  forceUnlockOperations();
  Object.keys(releaseTimers).forEach(timerId => {
    clearTimeout(releaseTimers[timerId]);
  });
  Object.keys(sliderTimers).forEach(timerId => {
    clearInterval(sliderTimers[timerId]);
  });
});

// æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ é¡µé¢å¯è§æ€§ç›‘å¬ï¼Œåˆ‡å›é¡µé¢æ—¶å¼ºåˆ¶è§£é”
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    forceUnlockOperations();
  }
});

window.addEventListener('resize', positionSliders);
</script>

</body>
</html>
