<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>BLE æœºæ¢°è‡‚æ§åˆ¶ - 6ç»„æ»‘å—ç²¾å‡†å¯¹é½ç‰ˆ</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f5f5f5;
  user-select: none;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: #ffffff;
  box-shadow: 0 1px 4px rgba(0,0,0,.1);
}

header button {
  border: none;
  background: #eee;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}
header button:active, header button.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}
header button#bleConnectBtn.blink {
  animation: blink 1s step-end infinite;
}
header button#bleConnectBtn.connected {
  background: #2196f3 !important;
  color: #ffffff !important;
}
@keyframes blink {
  0% { background: #eee; color: #000; }
  50% { background: #ff4444; color: #ffffff; }
  100% { background: #eee; color: #000; }
}

.label-btn {
  width: 55px;
  height: 32px;
  border: none;
  background: #3b82f6;
  color: white;
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}
.label-btn:active, .label-btn.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}

footer {
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  max-width: 600px;
  margin: 20px auto 10px;
  width: 100%;
  box-sizing: border-box;
}
footer button {
  padding: 15px 10px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  background: #6366f1;
  color: white;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}
footer button.secondary {
  background: #64748b;
}
footer button:active, footer button.tap-active,
footer button.secondary:active, footer button.secondary.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}

main {
  position: relative;
  padding: 10px;
  max-width: 600px;
  margin: 0 auto;
  height: calc(100vw * 1.302);
  max-height: calc(600px * 1.302);
  min-height: 400px;
  width: 100%;
  box-sizing: border-box;
  overflow: hidden;
  background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
  border-radius: 8px;
}

.arm-bg {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.9;
  border-radius: 8px;
  margin: 0 auto;
  background: transparent;
}

.slider-group {
  position: absolute;
  left: 5%;
  right: 5%;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.8);
  padding: 6px 10px;
  border-radius: 25px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 10;
}

.slider-group input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  border-radius: 3px;
  background: #e2e8f0;
  outline: none;
  margin: 0;
}
.slider-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #3b82f6;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.1s ease;
}
.slider-group input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #3b82f6;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.1s ease;
}

#configModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#configBox {
  background: white;
  padding: 20px;
  width: 85%;
  max-width: 400px;
  border-radius: 12px;
  max-height: 90vh;
  overflow-y: auto;
}

#configBox label {
  font-size: 14px;
  display: block;
  margin-top: 12px;
  color: #666;
}

#configBox input, #configBox select {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-sizing: border-box;
}

.modal-btns {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.modal-btns button {
  flex: 1;
  padding: 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  transition: background-color 0.05s linear;
}

.btn-save { background: #3b82f6; color: white; }
.btn-close { background: #eee; color: #333; }
.btn-save:active, .btn-save.tap-active,
.btn-close:active, .btn-close.tap-active {
  background: #ff4444 !important;
  color: #ffffff !important;
}

#statusInfo {
  font-size: 12px;
  color: #666;
  text-align: center;
  margin-top: 5px;
  height: 15px;
  width: 100%;
}
</style>
</head>

<body>

<header>
  <button onclick="openConfig()">âš™ é…ç½®</button>
  <div style="font-weight: bold;">æœºæ¢°è‡‚æ§åˆ¶ç³»ç»Ÿ</div>
  <button id="bleConnectBtn" onclick="connectBLE()">ğŸ”µ è¿æ¥è“ç‰™</button>
</header>

<div id="statusInfo">æœªè¿æ¥è“ç‰™</div>

<main>
  <img class="arm-bg" src="jxb.jpg" onerror="handleImageError(this)" />
  <div class="slider-group s1" data-joint-y="12">
    <button class="label-btn" id="L1">å¼ å¼€</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="1" onmousedown="sliderDown(1, this)" ontouchstart="sliderDown(1, this)" onmouseup="sliderUp(1, this)" ontouchend="sliderUp(1, this)" oninput="sliderMove(1, this)">
    <button class="label-btn" id="R1">é—­åˆ</button>
  </div>
  <div class="slider-group s2" data-joint-y="27.5">
    <button class="label-btn" id="L2">å·¦è½¬</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="2" onmousedown="sliderDown(2, this)" ontouchstart="sliderDown(2, this)" onmouseup="sliderUp(2, this)" ontouchend="sliderUp(2, this)" oninput="sliderMove(2, this)">
    <button class="label-btn" id="R2">å³è½¬</button>
  </div>
  <div class="slider-group s3" data-joint-y="42.8">
    <button class="label-btn" id="L3">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="3" onmousedown="sliderDown(3, this)" ontouchstart="sliderDown(3, this)" onmouseup="sliderUp(3, this)" ontouchend="sliderUp(3, this)" oninput="sliderMove(3, this)">
    <button class="label-btn" id="R3">å‘å‰</button>
  </div>
  <div class="slider-group s4" data-joint-y="58">
    <button class="label-btn" id="L4">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="4" onmousedown="sliderDown(4, this)" ontouchstart="sliderDown(4, this)" onmouseup="sliderUp(4, this)" ontouchend="sliderUp(4, this)" oninput="sliderMove(4, this)">
    <button class="label-btn" id="R4">å‘å‰</button>
  </div>
  <div class="slider-group s5" data-joint-y="73.2">
    <button class="label-btn" id="L5">å‘å</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="5" onmousedown="sliderDown(5, this)" ontouchstart="sliderDown(5, this)" onmouseup="sliderUp(5, this)" ontouchend="sliderUp(5, this)" oninput="sliderMove(5, this)">
    <button class="label-btn" id="R5">å‘å‰</button>
  </div>
  <div class="slider-group s6" data-joint-y="88.7">
    <button class="label-btn" id="L6">å·¦è½¬</button>
    <input type="range" min="0" max="6" value="3" data-slider-id="6" onmousedown="sliderDown(6, this)" ontouchstart="sliderDown(6, this)" onmouseup="sliderUp(6, this)" ontouchend="sliderUp(6, this)" oninput="sliderMove(6, this)">
    <button class="label-btn" id="R6">å³è½¬</button>
  </div>
</main>

<footer>
  <button id="G1">G1</button>
  <button id="G2">G2</button>
  <button id="G3">G3</button>
  <button id="G4">G4</button>
  <button class="secondary" id="STOP">åœæ­¢</button>
  <button class="secondary" id="RESET">å¤ä½</button>
</footer>

<div id="configModal">
  <div id="configBox">
    <h3 style="margin:0">åŠŸèƒ½é…ç½®</h3>
    <label>é€‰æ‹©æŒ‰é’®åºå·</label>
    <select id="cfgId" onchange="loadCurrentConfig()">
      <optgroup label="æ»‘å—ä¾§è¾¹æŒ‰é’®ã€6ç»„å®Œæ•´ã€‘">
        <option value="L1">æ»‘å—1-å·¦(å¼ å¼€)</option><option value="R1">æ»‘å—1-å³(é—­åˆ)</option>
        <option value="L2">æ»‘å—2-å·¦(å·¦è½¬)</option><option value="R2">æ»‘å—2-å³(å³è½¬)</option>
        <option value="L3">æ»‘å—3-å·¦(å‘å)</option><option value="R3">æ»‘å—3-å³(å‘å‰)</option>
        <option value="L4">æ»‘å—4-å·¦(å‘å)</option><option value="R4">æ»‘å—4-å³(å‘å‰)</option>
        <option value="L5">æ»‘å—5-å·¦(å‘å)</option><option value="R5">æ»‘å—5-å³(å‘å‰)</option>
        <option value="L6">æ»‘å—6-å·¦(å·¦è½¬)</option><option value="R6">æ»‘å—6-å³(å³è½¬)</option>
      </optgroup>
      <optgroup label="åº•éƒ¨åŠŸèƒ½æŒ‰é’®">
        <option value="G1">æŒ‰é’® G1</option><option value="G2">æŒ‰é’® G2</option>
        <option value="G3">æŒ‰é’® G3</option><option value="G4">æŒ‰é’® G4</option>
        <option value="STOP">åœæ­¢æŒ‰é’®</option><option value="RESET">å¤ä½æŒ‰é’®</option>
      </optgroup>
    </select>
    <label>æŒ‰é’®æ˜¾ç¤ºåç§°</label>
    <input id="cfgName">
    <label>æŒ‰ä¸‹å‘½ä»¤</label>
    <input id="cfgPress">
    <label>æŠ¬èµ·å‘½ä»¤ (å¯é€‰)</label>
    <input id="cfgRelease">
    <label>æŠ¬èµ·å»¶è¿Ÿ(æ¯«ç§’ï¼Œé»˜è®¤200)</label>
    <input id="cfgReleaseDelay" type="number" min="0" placeholder="200">
    <div class="modal-btns">
      <button class="btn-save" onclick="saveConfig()">ä¿å­˜</button>
      <button class="btn-close" onclick="closeConfig()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡æ˜ç¡®ç»‘å®šåˆ°windowï¼Œé¿å…ä½œç”¨åŸŸå†²çª
window.bleChar = null;
window.bleDevice = null; 
let sliderTimers = {};
let sliderHeld = {};
let imageLoaded = false;
// æ–°å¢ï¼šè®°å½•å½“å‰æ»‘å—è§¦å‘çš„æŒ‰é’®IDï¼Œç”¨äºå›å¼¹æ—¶å‘é€æŠ¬èµ·æŒ‡ä»¤
let sliderActiveBtn = {};
// æ–°å¢ï¼šç®¡ç†æŠ¬èµ·æŒ‡ä»¤çš„å»¶è¿Ÿè®¡æ—¶å™¨
let releaseTimers = {};
// æ–°å¢ï¼šé»˜è®¤æŠ¬èµ·å»¶è¿Ÿæ—¶é—´(ms)
const DEFAULT_RELEASE_DELAY = 200;
const bleBtn = document.getElementById('bleConnectBtn');
// æ–°å¢ï¼šå µè½¬ä¿æŠ¤å…¨å±€å˜é‡
const STALL_CURRENT_THRESHOLD = 800; // å µè½¬ç”µæµé˜ˆå€¼ï¼ˆmAï¼Œæ ¹æ®èˆµæœºå‚æ•°è°ƒæ•´ï¼‰
const CMD_TIMEOUT = 2000; // æŒ‡ä»¤è¶…æ—¶æ—¶é—´ï¼ˆmsï¼‰
let cmdTimeoutTimers = {}; // è®°å½•æ¯ä¸ªèˆµæœºçš„è¶…æ—¶è®¡æ—¶å™¨

document.addEventListener('DOMContentLoaded', function() {
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(btn => {
    btn.addEventListener('touchstart', function() {
      this.classList.add('tap-active');
    }, { passive: true });
    btn.addEventListener('touchend', function() {
      this.classList.remove('tap-active');
    });
    btn.addEventListener('touchmove', function(e) {
      const rect = this.getBoundingClientRect();
      const x = e.touches[0].clientX;
      const y = e.touches[0].clientY;
      if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        this.classList.remove('tap-active');
      }
    }, { passive: true });
    btn.addEventListener('touchcancel', function() {
      this.classList.remove('tap-active');
    });
    btn.addEventListener('mousedown', function() {
      this.classList.add('tap-active');
    });
    btn.addEventListener('mouseup', function() {
      this.classList.remove('tap-active');
    });
    btn.addEventListener('mouseleave', function() {
      this.classList.remove('tap-active');
    });
  });
});

function handleImageError(img) {
  console.log('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å¸ƒå±€');
  imageLoaded = false;
  img.style.opacity = '0';
  positionSliders();
}

const defaultConfigs = {
  L1: { name: "å¼ å¼€", press: "#005P0500T2000!", release: "#005PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  R1: { name: "é—­åˆ", press: "#005P2500T2000!", release: "#005PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  L2: { name: "å·¦è½¬", press: "#004P0500T2000!", release: "#004PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  R2: { name: "å³è½¬", press: "#004P2500T2000!", release: "#004PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  L3: { name: "å‘å", press: "#003P0500T2000!", release: "#003PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  R3: { name: "å‘å‰", press: "#003P2500T2000!", release: "#003PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  L4: { name: "å‘å", press: "#002P0500T2000!", release: "#002PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  R4: { name: "å‘å‰", press: "#002P2500T2000!", release: "#002PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  L5: { name: "å‘å", press: "#001P2500T2000!", release: "#001PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  R5: { name: "å‘å‰", press: "#001P0500T2000!", release: "#001PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  L6: { name: "å·¦è½¬", press: "#000P2500T2000!", release: "#000PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  R6: { name: "å³è½¬", press: "#000P0500T2000!", release: "#000PDST!", releaseDelay: DEFAULT_RELEASE_DELAY },
  G1: { name: "G1", press: "$DBT:1,1!", release: "", releaseDelay: DEFAULT_RELEASE_DELAY },
  G2: { name: "G2", press: "$DBT:2,1!", release: "", releaseDelay: DEFAULT_RELEASE_DELAY },
  G3: { name: "G3", press: "$DBT:3,1!", release: "", releaseDelay: DEFAULT_RELEASE_DELAY },
  G4: { name: "G4", press: "$DBT:4,1!", release: "", releaseDelay: DEFAULT_RELEASE_DELAY },
  STOP: { name: "åœæ­¢", press: "$DST!", release: "", releaseDelay: DEFAULT_RELEASE_DELAY },
  RESET: { name: "å¤ä½", press: "$RST!", release: "", releaseDelay: DEFAULT_RELEASE_DELAY }
};

let buttonConfigs = JSON.parse(localStorage.getItem("btnCfgV3")) || defaultConfigs;

function initButtons() {
  Object.keys(buttonConfigs).forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    const cfg = buttonConfigs[btnId];
    btn.innerText = cfg.name || btnId;
    btn.removeEventListener('mousedown', handleBtnPress);
    btn.removeEventListener('mouseup', handleBtnRelease);
    btn.removeEventListener('touchstart', handleBtnPress);
    btn.removeEventListener('touchend', handleBtnRelease);
    btn.addEventListener('mousedown', handleBtnPress);
    btn.addEventListener('mouseup', handleBtnRelease);
    btn.addEventListener('touchstart', handleBtnPress, { passive: false });
    btn.addEventListener('touchend', handleBtnRelease, { passive: false });
  });
}

function handleBtnPress(e) {
  if (e.cancelable) e.preventDefault();
  const btnId = e.target.id;
  // æ¸…é™¤è¯¥æŒ‰é’®çš„ç°æœ‰å»¶è¿Ÿè®¡æ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
  if (releaseTimers[btnId]) {
    clearTimeout(releaseTimers[btnId]);
    delete releaseTimers[btnId];
  }
  const cfg = buttonConfigs[btnId];
  if (cfg && cfg.press) send(cfg.press);
}

function handleBtnRelease(e) {
  if (e.cancelable) e.preventDefault();
  const btnId = e.target.id;
  const cfg = buttonConfigs[btnId];
  
  // å¦‚æœæœ‰æŠ¬èµ·æŒ‡ä»¤ï¼Œå»¶è¿Ÿå‘é€
  if (cfg && cfg.release) {
    // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨ï¼Œé¿å…é‡å¤æ‰§è¡Œ
    if (releaseTimers[btnId]) {
      clearTimeout(releaseTimers[btnId]);
    }
    // è·å–å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤200ms
    const delay = cfg.releaseDelay || DEFAULT_RELEASE_DELAY;
    // è®¾ç½®æ–°çš„å»¶è¿Ÿè®¡æ—¶å™¨
    releaseTimers[btnId] = setTimeout(() => {
      send(cfg.release);
      console.log(`ã€æŒ‰é’®${btnId}ã€‘å»¶è¿Ÿ${delay}mså‘é€æŠ¬èµ·æŒ‡ä»¤: ${cfg.release}`);
      // æ‰§è¡Œå®Œæˆåæ¸…é™¤è®¡æ—¶å™¨è®°å½•
      delete releaseTimers[btnId];
    }, delay);
  }
}

function sliderDown(sliderId, sliderEl) {
  sliderHeld[sliderId] = true;
  // æ¸…é™¤è¯¥æ»‘å—çš„ç°æœ‰å»¶è¿Ÿè®¡æ—¶å™¨
  if (releaseTimers[`slider_${sliderId}`]) {
    clearTimeout(releaseTimers[`slider_${sliderId}`]);
    delete releaseTimers[`slider_${sliderId}`];
  }
  judgeSliderLevel(sliderId, sliderEl);
}

function sliderMove(sliderId, sliderEl) {
  if (!sliderHeld[sliderId]) return;
  judgeSliderLevel(sliderId, sliderEl, true);
}

function sliderUp(sliderId, sliderEl) {
  sliderHeld[sliderId] = false;
  if (sliderTimers[sliderId]) {
    clearInterval(sliderTimers[sliderId]);
    delete sliderTimers[sliderId];
  }
  // æ»‘å—å›å¼¹åˆ°ä¸­é—´ä½ç½®
  sliderEl.value = 3;
  // å»¶è¿Ÿå‘é€æŠ¬èµ·æŒ‡ä»¤
  sendSliderReleaseCmd(sliderId);
  // æ¸…ç©ºå½“å‰æ¿€æ´»çš„æŒ‰é’®è®°å½•
  delete sliderActiveBtn[sliderId];
}

function judgeSliderLevel(sliderId, sliderEl, isMoving = false) {
  let currentVal = parseInt(sliderEl.value);
  const levels = [0, 1, 2, 3, 4, 5, 6];
  const nearestLevel = levels.reduce((a, b) => Math.abs(b - currentVal) < Math.abs(a - currentVal) ? b : a);
  sliderEl.value = nearestLevel;

  if (nearestLevel === 3) {
    if (sliderTimers[sliderId]) {
      clearInterval(sliderTimers[sliderId]);
      delete sliderTimers[sliderId];
    }
    // æ»‘å—å›åˆ°ä¸­é—´ä½ç½®æ—¶å»¶è¿Ÿå‘é€æŠ¬èµ·æŒ‡ä»¤
    sendSliderReleaseCmd(sliderId);
    // æ¸…ç©ºå½“å‰æ¿€æ´»çš„æŒ‰é’®è®°å½•
    delete sliderActiveBtn[sliderId];
    return;
  }

  const leftBtnId = `L${sliderId}`;
  const rightBtnId = `R${sliderId}`;
  const targetBtnId = nearestLevel < 3 ? leftBtnId : rightBtnId;
  // è®°å½•å½“å‰æ¿€æ´»çš„æŒ‰é’®ID
  sliderActiveBtn[sliderId] = targetBtnId;
  
  const originalCmd = buttonConfigs[targetBtnId]?.press;
  
  if (!originalCmd || !window.bleChar) return;

  const level = nearestLevel < 3 ? 3 - nearestLevel : nearestLevel - 3;
  const newCmd = calculateLevelCmd(originalCmd, level);
  if (!newCmd) return;

  if (!isMoving || !sliderTimers[sliderId]) {
    send(newCmd);
  }

  const tMatch = newCmd.match(/T(\d+)!/);
  const interval = tMatch ? parseInt(tMatch[1]) : 2000;

  if (sliderTimers[sliderId]) clearInterval(sliderTimers[sliderId]);
  sliderTimers[sliderId] = setInterval(() => {
    if (sliderHeld[sliderId]) send(newCmd);
  }, interval);
}

// æ–°å¢ï¼šå‘é€æ»‘å—å¯¹åº”çš„æŠ¬èµ·æŒ‡ä»¤ï¼ˆå¸¦å»¶è¿Ÿï¼‰
function sendSliderReleaseCmd(sliderId) {
  const activeBtnId = sliderActiveBtn[sliderId];
  if (!activeBtnId) return;
  
  // æ¸…é™¤è¯¥æ»‘å—çš„ç°æœ‰å»¶è¿Ÿè®¡æ—¶å™¨
  const timerKey = `slider_${sliderId}`;
  if (releaseTimers[timerKey]) {
    clearTimeout(releaseTimers[timerKey]);
  }
  
  const cfg = buttonConfigs[activeBtnId];
  if (cfg && cfg.release) {
    // è·å–å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤200ms
    const delay = cfg.releaseDelay || DEFAULT_RELEASE_DELAY;
    // è®¾ç½®æ–°çš„å»¶è¿Ÿè®¡æ—¶å™¨
    releaseTimers[timerKey] = setTimeout(() => {
      send(cfg.release);
      console.log(`ã€æ»‘å—${sliderId}ã€‘å»¶è¿Ÿ${delay}mså‘é€æŠ¬èµ·æŒ‡ä»¤: ${cfg.release}`);
      // æ‰§è¡Œå®Œæˆåæ¸…é™¤è®¡æ—¶å™¨è®°å½•
      delete releaseTimers[timerKey];
    }, delay);
  }
}

function calculateLevelCmd(originalCmd, level) {
  const cmdMatch = originalCmd.match(/(#\d+P\d+T)(\d+)(!)/);
  if (!cmdMatch) return null;
  const [, prefix, tVal, suffix] = cmdMatch;
  const originalT = parseInt(tVal);

  let newT;
  switch (level) {
    case 1: newT = originalT; break;
    case 2: newT = Math.floor(originalT * 2 / 3); break;
    case 3: newT = Math.floor(originalT * 1 / 3); break;
    default: return null;
  }

  return `${prefix}${newT}${suffix}`;
}

function openConfig() {
  document.getElementById('configModal').style.display = "flex";
  loadCurrentConfig();
}

function closeConfig() {
  document.getElementById('configModal').style.display = "none";
}

function loadCurrentConfig() {
  const id = document.getElementById('cfgId').value;
  const cfg = buttonConfigs[id] || { name: "", press: "", release: "", releaseDelay: DEFAULT_RELEASE_DELAY };
  document.getElementById('cfgName').value = cfg.name || "";
  document.getElementById('cfgPress').value = cfg.press || "";
  document.getElementById('cfgRelease').value = cfg.release || "";
  document.getElementById('cfgReleaseDelay').value = cfg.releaseDelay || DEFAULT_RELEASE_DELAY;
}

function saveConfig() {
  const id = document.getElementById('cfgId').value;
  const releaseDelay = parseInt(document.getElementById('cfgReleaseDelay').value) || DEFAULT_RELEASE_DELAY;
  buttonConfigs[id] = {
    name: document.getElementById('cfgName').value.trim(),
    press: document.getElementById('cfgPress').value.trim(),
    release: document.getElementById('cfgRelease').value.trim(),
    releaseDelay: releaseDelay
  };
  localStorage.setItem("btnCfgV3", JSON.stringify(buttonConfigs));
  initButtons();
  closeConfig();
}

// æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢ä¸ºå¯å†™å…¥çš„ffe2ç‰¹å¾å€¼UUID
// ä¼˜åŒ–åçš„è“ç‰™è¿æ¥å‡½æ•°ï¼ˆé€‚é…ç”µè„‘ç«¯ï¼Œè§£å†³GATTæ–­å¼€é”™è¯¯ï¼‰
async function connectBLE() {
  const status = document.getElementById('statusInfo');
  bleBtn.classList.remove('connected');
  bleBtn.classList.add('blink');
  bleBtn.disabled = true;

  // é‡ç½®æ‰€æœ‰è“ç‰™çŠ¶æ€å’Œè®¡æ—¶å™¨
  window.bleChar = null;
  window.bleDevice = null;
  Object.keys(cmdTimeoutTimers).forEach(id => clearTimeout(cmdTimeoutTimers[id]));

  // BLEæœåŠ¡å’Œç‰¹å¾å€¼UUIDï¼ˆä¸ä½ çš„æ¨¡å—åŒ¹é…ï¼‰
  const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
  const CHAR_UUID = '0000ffe2-0000-1000-8000-00805f9b34fb';
  const MAX_RETRY = 2; // ç”µè„‘ç«¯å¢åŠ é‡è¯•æ¬¡æ•°ï¼Œè§£å†³æ¡æ‰‹å»¶è¿Ÿ
  let retryCount = 0;

  try {
    // 1. è¯·æ±‚è®¾å¤‡ï¼ˆç”µè„‘ç«¯éœ€ç¡®ä¿æƒé™å¼¹çª—æ­£å¸¸å¼¹å‡ºï¼‰
    status.innerText = "æ­£åœ¨æœç´¢è“ç‰™è®¾å¤‡...";
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }],
      optionalServices: [SERVICE_UUID] // å¿…é¡»åŒ…å«ï¼Œå¦åˆ™ç”µè„‘ç«¯æ— æ³•è·å–æœåŠ¡
    });
    window.bleDevice = device;
    console.log("ã€å·²é€‰æ‹©è®¾å¤‡ã€‘:", device.name, device.id);

    // 2. ç›‘å¬æ–­å¼€äº‹ä»¶ï¼ˆç”µè„‘ç«¯æ–­å¼€æ›´é¢‘ç¹ï¼Œéœ€ç²¾å‡†æç¤ºï¼‰
    device.addEventListener('gattserverdisconnected', onDisconnected);

    // 3. é‡è¯•è¿æ¥GATTæœåŠ¡å™¨ï¼ˆç”µè„‘ç«¯æ ¸å¿ƒï¼šè§£å†³è¿æ¥åç¬é—´æ–­å¼€ï¼‰
    while (retryCount <= MAX_RETRY) {
      try {
        status.innerText = `ç¬¬${retryCount+1}æ¬¡è¿æ¥GATTæœåŠ¡å™¨...`;
        const server = await device.gatt.connect();
        console.log("ã€GATTè¿æ¥æˆåŠŸã€‘:", server.connected);

        // å…³é”®ï¼šç­‰å¾…æœåŠ¡å™¨å®Œå…¨å°±ç»ªï¼ˆç”µè„‘ç«¯GATTæ¡æ‰‹æœ‰å»¶è¿Ÿï¼Œæ¯”æ‰‹æœºé•¿ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));

        // 4. è·å–æœåŠ¡å’Œç‰¹å¾å€¼ï¼ˆç”µè„‘ç«¯éœ€æ ¡éªŒæœåŠ¡æ˜¯å¦å­˜åœ¨ï¼‰
        const service = await server.getPrimaryService(SERVICE_UUID);
        const characteristic = await service.getCharacteristic(CHAR_UUID);

        // 5. æ ¡éªŒå†™å…¥æƒé™ï¼ˆç”µè„‘ç«¯ä¸¥æ ¼æ ¡éªŒï¼Œé¿å…æ— æ•ˆç‰¹å¾å€¼ï¼‰
        if (!characteristic.properties.write && !characteristic.properties.writeWithoutResponse) {
          throw new Error("ç‰¹å¾å€¼ä¸æ”¯æŒå†™å…¥ï¼Œè¯·æ£€æŸ¥UUIDæ˜¯å¦æ­£ç¡®");
        }

        // 6. å¯ç”¨é€šçŸ¥ï¼ˆç”µè„‘ç«¯éœ€ç¡®ä¿é€šçŸ¥å¼€å¯æˆåŠŸï¼‰
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleBLEData);

        // è¿æ¥æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€
        window.bleChar = characteristic;
        bleBtn.classList.remove('blink');
        bleBtn.classList.add('connected');
        bleBtn.innerText = "ğŸ”µ å·²è¿è“ç‰™";
        status.innerText = `å·²è¿æ¥: ${device.name}ï¼ˆé‡è¯•${retryCount}æ¬¡ï¼‰`;
        status.style.color = "green";
        console.log("ã€æœ€ç»ˆè¿æ¥æˆåŠŸã€‘ç‰¹å¾å€¼UUID:", characteristic.uuid);
        return; // è¿æ¥æˆåŠŸï¼Œé€€å‡ºé‡è¯•å¾ªç¯

      } catch (retryErr) {
        retryCount++;
        console.warn(`ç¬¬${retryCount}æ¬¡è¿æ¥å¤±è´¥:`, retryErr.message);
        if (retryCount > MAX_RETRY) throw retryErr; // é‡è¯•è€—å°½ï¼ŒæŠ›å‡ºé”™è¯¯
        await new Promise(resolve => setTimeout(resolve, 1000)); // é‡è¯•é—´éš”1ç§’
      }
    }

  } catch (e) {
    // ç²¾å‡†æ•è·ç”µè„‘ç«¯å¸¸è§é”™è¯¯ï¼Œç»™å‡ºå¯¹åº”æç¤º
    bleBtn.classList.remove('blink');
    bleBtn.innerText = "ğŸ”µ è¿æ¥è“ç‰™";
    if (e.message.includes("GATT Server is disconnected")) {
      status.innerText = "è¿æ¥å¤±è´¥ï¼šè“ç‰™å·²æ–­å¼€ï¼Œè¯·é‡å¯ç”µè„‘è“ç‰™/æ¸…é™¤æµè§ˆå™¨ç¼“å­˜";
      status.style.color = "red";
    } else if (e.message.includes("User cancelled")) {
      status.innerText = "è¿æ¥å¤±è´¥ï¼šæœªé€‰æ‹©è“ç‰™è®¾å¤‡";
      status.style.color = "orange";
    } else {
      status.innerText = `è¿æ¥å¤±è´¥: ${e.message.substring(0, 20)}...`;
      status.style.color = "red";
    }
    console.error("è“ç‰™è¿æ¥æœ€ç»ˆå¤±è´¥:", e);
  } finally {
    bleBtn.disabled = false;
  }
}

// æ–°å¢ï¼šæ–­å¼€äº‹ä»¶å¤„ç†ï¼ˆç”µè„‘ç«¯æ›´ç²¾å‡†çš„çŠ¶æ€æç¤ºï¼‰
function onDisconnected() {
  window.bleChar = null;
  window.bleDevice = null;
  bleBtn.classList.remove('blink', 'connected');
  bleBtn.innerText = "ğŸ”µ è¿æ¥è“ç‰™";
  const status = document.getElementById('statusInfo');
  status.innerText = "è“ç‰™å·²æ–­å¼€ï¼šè¯·æ£€æŸ¥è®¾å¤‡è·ç¦»/ç”µè„‘è“ç‰™çŠ¶æ€";
  status.style.color = "orange";
  // æ¸…é™¤æ‰€æœ‰è¶…æ—¶è®¡æ—¶å™¨
  Object.keys(cmdTimeoutTimers).forEach(id => clearTimeout(cmdTimeoutTimers[id]));
}



// æ–°å¢ï¼šå¤„ç†è“ç‰™è¿”å›æ•°æ®
function handleBLEData(event) {
  const value = event.target.value;
  // å°†å­—èŠ‚æ•°æ®è½¬ä¸ºå­—ç¬¦ä¸²ï¼ˆæ ¹æ®ä½ çš„è®¾å¤‡åè®®è°ƒæ•´ï¼‰
  const decoder = new TextDecoder('utf-8');
  const response = decoder.decode(value);
  console.log("ã€æ¥æ”¶ã€‘è“ç‰™è¿”å›æ•°æ®ï¼š", response);

  const status = document.getElementById('statusInfo');
  // è§£æèˆµæœºçŠ¶æ€ï¼ˆç¤ºä¾‹ï¼šå‡è®¾è¿”å›æ ¼å¼ä¸º "#ANG:001,90!#CUR:001,500!" è¡¨ç¤ºèˆµæœº1è§’åº¦90Â°ï¼Œç”µæµ500mAï¼‰
  if (response.includes("#ANG:")) {
    // æå–è§’åº¦æ•°æ®ï¼ˆæ­£åˆ™åŒ¹é…ï¼Œæ ¹æ®å®é™…åè®®ä¿®æ”¹ï¼‰
    const angleMatch = response.match(/#ANG:(\d+),(\d+)!/);
    if (angleMatch) {
      const servoId = angleMatch[1];
      const angle = angleMatch[2];
      status.innerText = `èˆµæœº${servoId}å½“å‰è§’åº¦ï¼š${angle}Â°`;
      status.style.color = "blue";
    }
  }
  // è§£æå µè½¬çŠ¶æ€ï¼ˆç¤ºä¾‹ï¼šå‡è®¾è¿”å› "#STALL:001!" è¡¨ç¤ºèˆµæœº1å µè½¬ï¼‰
  if (response.includes("#STALL:")) {
    const stallMatch = response.match(/#STALL:(\d+)!/);
    if (stallMatch) {
      const servoId = stallMatch[1];
      status.innerText = `âš ï¸ èˆµæœº${servoId}å µè½¬ï¼Œå·²åœæ­¢`;
      status.style.color = "red";
      // è§¦å‘åœæ­¢æŒ‡ä»¤ï¼Œé¿å…æŒç»­å µè½¬
      send("$DST!");
    }
  }
}


// æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨windowå…¨å±€å˜é‡ï¼Œé¿å…ä½œç”¨åŸŸå†²çª
async function send(cmd) {
  const status = document.getElementById('statusInfo');
  // å¼ºåˆ¶è·å–å…¨å±€å˜é‡
  const bleChar = window.bleChar;
  const bleDevice = window.bleDevice;
  
  // 1. åŸºç¡€æ ¡éªŒ
  if (!cmd) {
    console.warn("ç©ºæŒ‡ä»¤ï¼Œè·³è¿‡å‘é€");
    return;
  }
  
  // 2. æ ¡éªŒè“ç‰™è¿æ¥çŠ¶æ€
  if (!bleChar || !bleDevice || !bleDevice.gatt.connected) {
    status.innerText = "è“ç‰™æœªè¿æ¥ï¼Œæ— æ³•å‘é€æŒ‡ä»¤";
    status.style.color = "red";
    console.error("è“ç‰™æœªè¿æ¥ï¼šbleChar=", bleChar, "bleDevice.connected=", bleDevice?.gatt?.connected);
    return;
  }

  try {
    const data = new TextEncoder().encode(cmd);
    // 3. ä¼˜å…ˆä½¿ç”¨æ— å“åº”å†™å…¥ï¼ˆBLEè®¾å¤‡æ›´å…¼å®¹ï¼‰
    if (bleChar.writeValueWithoutResponse) {
      await bleChar.writeValueWithoutResponse(data);
    } else if (bleChar.writeValue) {
      await bleChar.writeValue(data);
    } else {
      throw new Error("æµè§ˆå™¨ä¸æ”¯æŒBLEå†™å…¥æ“ä½œ");
    }


    // === æ–°å¢ï¼šæŒ‡ä»¤è¶…æ—¶ä¿æŠ¤ ===
    const servoMatch = cmd.match(/#(\d+)P/);
    if (servoMatch) {
      const servoId = servoMatch[1];
      if (cmdTimeoutTimers[servoId]) clearTimeout(cmdTimeoutTimers[servoId]);
      cmdTimeoutTimers[servoId] = setTimeout(() => {
        status.innerText = `âš ï¸ èˆµæœº${servoId}æŒ‡ä»¤è¶…æ—¶ï¼Œå¼ºåˆ¶åœæ­¢`;
        status.style.color = "red";
        send("$DST!");
        // å›å¼¹æ‰€æœ‰æ»‘å—
        document.querySelectorAll('input[type="range"]').forEach(slider => {
          slider.value = 3;
        });
      }, CMD_TIMEOUT);
    }
	
    // æ›´æ–°çŠ¶æ€æç¤º
    status.innerText = `å‘é€æˆåŠŸ: ${cmd.substring(0, 10)}...`;
    status.style.color = "green";
    // 2ç§’åæ¢å¤çŠ¶æ€
    setTimeout(() => {
      if (bleDevice && bleDevice.gatt.connected) {
        status.innerText = "å·²è¿æ¥: " + bleDevice.name;
      }
    }, 2000);
    console.log("ã€æˆåŠŸã€‘å‘é€æŒ‡ä»¤ï¼š", cmd);
  } catch (e) {
    status.innerText = `å‘é€å¤±è´¥: ${e.message}`;
    status.style.color = "red";
    console.error("æŒ‡ä»¤å‘é€å¤±è´¥:", e);
    
    // è‡ªåŠ¨é‡è¿é€»è¾‘
    if (e.message.includes("GATT operation not permitted") && bleDevice) {
      try {
        await bleDevice.gatt.connect();
        status.innerText = "å·²é‡è¿è“ç‰™ï¼Œå¯é‡è¯•å‘é€";
        console.log("ã€æˆåŠŸã€‘è‡ªåŠ¨é‡è¿è“ç‰™");
      } catch (reconnectErr) {
        status.innerText = "é‡è¿å¤±è´¥ï¼Œè¯·é‡æ–°è¿æ¥è“ç‰™";
        window.bleChar = null;
        bleBtn.classList.remove('connected');
        bleBtn.innerText = "ğŸ”µ è¿æ¥è“ç‰™";
        console.error("é‡è¿å¤±è´¥:", reconnectErr);
      }
    }
  }
}

function positionSliders() {
  const mainContainer = document.querySelector('main');
  const bgImg = document.querySelector('.arm-bg');
  
  let containerHeight;
  if (imageLoaded && bgImg.offsetHeight > 0) {
    containerHeight = bgImg.offsetHeight;
  } else {
    containerHeight = mainContainer.clientHeight;
  }
  
  document.querySelectorAll('.slider-group').forEach(group => {
    const jointYPercent = parseFloat(group.dataset.jointY);
    const top = (containerHeight * jointYPercent / 100) - (group.offsetHeight / 2);
    group.style.top = `${top}px`;
  });
}

function handleImageLoad(img) {
  console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
  imageLoaded = true;
  img.style.opacity = '0.9';
  positionSliders();
}

window.onload = () => {
  initButtons();
  [1,2,3,4,5,6].forEach(id => {
    sliderHeld[id] = false;
    sliderTimers[id] = null;
    sliderActiveBtn[id] = null; // åˆå§‹åŒ–æ¿€æ´»æŒ‰é’®è®°å½•
    releaseTimers[`slider_${id}`] = null; // åˆå§‹åŒ–å»¶è¿Ÿè®¡æ—¶å™¨
  });
  
  const bgImg = document.querySelector('.arm-bg');
  bgImg.addEventListener('load', function() {
    handleImageLoad(this);
  });
  
  if (bgImg.complete && bgImg.naturalHeight !== 0) {
    handleImageLoad(bgImg);
  }
  
  setTimeout(positionSliders, 100);
};

window.addEventListener('resize', positionSliders);

// é¡µé¢å¸è½½æ—¶æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
window.addEventListener('beforeunload', function() {
  // æ¸…é™¤æŒ‰é’®å»¶è¿Ÿè®¡æ—¶å™¨
  Object.keys(releaseTimers).forEach(key => {
    clearTimeout(releaseTimers[key]);
  });
  // æ¸…é™¤æ»‘å—è®¡æ—¶å™¨
  Object.keys(sliderTimers).forEach(key => {
    clearInterval(sliderTimers[key]);
  });
});
</script>

</body>
</html>

